generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                  @id @default(uuid()) // ID định danh duy nhất của User, tự động tạo UUID
  email                  String // Địa chỉ email dùng để đăng nhập và liên hệ
  firstName              String? // Tên người dùng (có thể để trống)
  lastName               String? // Họ người dùng (có thể để trống)
  password               String?                 @db.VarChar(255) // Mật khẩu đã được mã hóa (Hash), giới hạn 255 ký tự
  createdAt              DateTime                @default(now()) // Thời điểm tạo tài khoản
  updatedAt              DateTime                @updatedAt // Thời điểm cập nhật thông tin gần nhất
  deletedAt              DateTime? // Thời điểm xóa mềm (Soft delete). Nếu có giá trị nghĩa là tài khoản đã bị vô hiệu hóa
  avatarUrl              String? // Đường dẫn ảnh đại diện (URL)
  provider               String? // Nhà cung cấp đăng nhập (Google, Facebook) nếu dùng Social Login
  socialId               String? // ID định danh từ mạng xã hội (VD: Google User ID)
  twoFactorEnabled       Boolean                 @default(false) // Cờ bật/tắt tính năng bảo mật 2 lớp (2FA)
  twoFactorSecret        String? // Mã bí mật dùng để tạo OTP cho 2FA
  whitelistedIps         Json?                   @default("[]") // Danh sách các địa chỉ IP được phép truy cập (lớp bảo mật thêm)
  commissionBalance      Decimal                 @default(0) @db.Decimal(20, 2) // Số dư hoa hồng tích lũy (cho content creator/affiliate)
  referredByUserId       String?
  referredByUser         User?                   @relation("UserReferrals", fields: [referredByUserId], references: [id])
  referrals              User[]                  @relation("UserReferrals")
  commissionTransactions CommissionTransaction[]

  // Media Reference
  avatarId String?
  avatar   Media?  @relation(fields: [avatarId], references: [id])

  // Các mối quan hệ (Relations) với các bảng khác
  addresses      Address[] // Danh sách địa chỉ giao hàng của user
  auditLogs      AuditLog[] // Lịch sử hoạt động/truy vết của user
  carts          Cart[] // Giỏ hàng (thường chỉ 1 active, nhưng thiết kế mảng để mở rộng history)
  inventoryLogs  InventoryLog[] // Log kho hàng (nếu user là nhân viên kho)
  notifications  Notification[] // Các thông báo gửi đến user
  orders         Order[] // Lịch sử đơn hàng đã mua
  reviews        Review[] // Các đánh giá sản phẩm đã mua
  permissions    UserPermission[] // Các quyền hạn cụ thể (Granular permissions)
  roles          UserRole[] // Các vai trò của user (Admin, Staff, Customer...)
  wishlist       Wishlist[] // Danh sách sản phẩm yêu thích
  blogs          Blog[] // Bài viết blog (nếu user là content writer)
  conversations  ChatConversation[] // Các cuộc hội thoại chat support
  aiChatSessions AiChatSession[] // Lịch sử chat với AI Bot
  ownedTenants   Tenant[]           @relation("TenantOwner")

  // Multi-tenancy (Đa cửa hàng)
  tenantId String // ID của cửa hàng mà User này thuộc về
  tenant   Tenant @relation(fields: [tenantId], references: [id]) // Quan hệ tới bảng Tenant

  // Customer Group
  customerGroupId String?
  customerGroup   CustomerGroup?   @relation(fields: [customerGroupId], references: [id])
  promotions      PromotionUsage[]
  returnRequests  ReturnRequest[]

  @@unique([tenantId, email]) // Đảm bảo email là duy nhất trong phạm vi một cửa hàng
  @@unique([id, tenantId]) // Composite Key cho bảo mật mức Tenant
  // Các chỉ mục (Indexes) để tối ưu truy vấn
  @@index([email]) // Tìm kiếm nhanh theo email
  @@index([tenantId]) // Lọc nhanh user theo cửa hàng
  @@index([tenantId, createdAt(sort: Desc)]) // Sắp xếp user mới nhất trong từng cửa hàng
  @@index([customerGroupId]) // Index cho khóa ngoại CustomerGroup
}

// =====================================================================
// MEDIA MANAGEMENT
// =====================================================================

model Media {
  id        String    @id @default(uuid())
  url       String    @db.VarChar(2048) // URL của file media
  type      String    @db.VarChar(50) // Loại file (image, video, document)
  mimeType  String?   @db.VarChar(100) // MIME type (image/jpeg, video/mp4)
  fileName  String?   @db.VarChar(255) // Tên file gốc
  altText   String?   @db.VarChar(255) // Văn bản thay thế cho SEO và trợ năng
  size      Int? // Kích thước file theo byte
  width     Int? // Chiều rộng (đối với ảnh/video)
  height    Int? // Chiều cao (đối với ảnh/video)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Multi-tenancy
  tenantId String // ID của Tenant sở hữu media này
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Relations
  users         User[]
  categories    Category[]
  brands        Brand[]
  blogs         Blog[]
  productImages ProductImage[]
  skuImages     SkuImage[]
  optionValues  OptionValue[]

  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, createdAt(sort: Desc)])
}

model CustomerGroup {
  id          String  @id @default(uuid())
  name        String // VIP, Wholesale
  description String?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  users User[]

  // Price List (B2B)
  priceListId String?
  priceList   PriceList? @relation(fields: [priceListId], references: [id])

  createdAt DateTime @default(now()) // Ngày tạo
  updatedAt DateTime @updatedAt // Ngày cập nhật

  @@unique([tenantId, name])
  @@index([priceListId]) // Index cho khóa ngoại PriceList
}

// =====================================================================
// B2B - PRICE LISTS
// =====================================================================

model PriceList {
  id        String    @id @default(uuid())
  name      String // Bảng giá đại lý, Bảng giá bán lẻ
  currency  String    @default("VND")
  isDefault Boolean   @default(false)
  startDate DateTime?
  endDate   DateTime?
  isActive  Boolean   @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  items          PriceListItem[]
  customerGroups CustomerGroup[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model PriceListItem {
  id             String   @id @default(uuid())
  priceListId    String
  skuId          String
  price          Decimal  @db.Decimal(20, 2) // Giá áp dụng
  compareAtPrice Decimal? @db.Decimal(20, 2) // Giá gốc (để gạch ngang)

  priceList PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  sku       Sku       @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@unique([priceListId, skuId])
  @@index([skuId]) // Index tối ưu truy vấn ngược từ SKU
}

model Role {
  id          String           @id @default(uuid()) // ID định danh duy nhất của Role (Vai trò)
  name        String // Tên của vai trò (VD: Admin, Staff, Viewer)
  createdAt   DateTime         @default(now()) // Thời gian tạo
  updatedAt   DateTime         @updatedAt // Thời gian cập nhật
  permissions RolePermission[] // Danh sách các quyền hạn thuộc vai trò này
  users       UserRole[] // Danh sách người dùng có vai trò này

  // Multi-tenancy
  tenantId String // ID của Tenant (Cửa hàng) sở hữu role này
  tenant   Tenant @relation(fields: [tenantId], references: [id]) // Quan hệ tới model Tenant

  @@unique([tenantId, name]) // Tên role phải là duy nhất trong cùng một Tenant
  @@index([tenantId]) // Index để lọc nhanh các role của một Tenant
}

model Permission {
  id        String           @id @default(uuid()) // ID của Quyền hạn
  name      String           @unique // Tên quyền hạn (Duy nhất toàn hệ thống, VD: PRODUCT_CREATE)
  createdAt DateTime         @default(now()) // Thời gian tạo
  updatedAt DateTime         @updatedAt // Thời gian cập nhật
  roles     RolePermission[] // Danh sách các Role có quyền này
  users     UserPermission[] // Danh sách User được gán trực tiếp quyền này
}

model UserRole {
  userId String // ID của User
  roleId String // ID của Role
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade) // Link tới Role
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade) // Link tới User

  @@id([userId, roleId]) // Khóa chính kết hợp (Một user chỉ có 1 lần role này)
  @@index([roleId]) // Index để tìm nhanh tất cả user có role này
}

model RolePermission {
  roleId       String // ID Role
  permissionId String // ID Permission
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId]) // Khóa chính kết hợp
  @@index([permissionId]) // Index tìm các role có permission này
}

model UserPermission {
  userId       String // ID User
  permissionId String // ID Permission
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade) // Link permission
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade) // Link user

  @@id([userId, permissionId]) // Khóa chính kết hợp
  @@index([permissionId]) // Index tìm user có permission này
}

model Category {
  id        String    @id @default(uuid()) // ID danh mục
  name      String // Tên danh mục (VD: Điện thoại, Quần áo)
  slug      String // Đường dẫn thân thiện SEO (VD: dien-thoai)
  parentId  String? // ID danh mục cha (nếu là danh mục con)
  createdAt DateTime  @default(now()) // Thời gian tạo
  updatedAt DateTime  @updatedAt // Thời gian cập nhật
  deletedAt DateTime? // Thời gian xóa mềm (Soft delete)
  imageUrl  String? // Ảnh đại diện danh mục (Legacy)
  imageId   String? // Link tới Media
  image     Media?    @relation(fields: [imageId], references: [id])

  metaDescription String? // Thẻ meta description cho SEO
  metaKeywords    String? // Thẻ meta keywords cho SEO
  metaTitle       String? // Thẻ meta title cho SEO
  parent          Category?           @relation("CategoryToCategory", fields: [parentId], references: [id]) // Link tới danh mục cha
  children        Category[]          @relation("CategoryToCategory") // Danh sách danh mục con
  products        ProductToCategory[] // Danh sách sản phẩm thuộc danh mục này

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, slug]) // Slug phải duy nhất trong Tenant
  @@unique([tenantId, name]) // Tên danh mục không trùng trong Tenant
  @@unique([id, tenantId]) // Bảo mật ID theo Tenant
  @@index([parentId]) // Index tìm danh mục con theo cha
  @@index([tenantId]) // Index lọc theo Tenant
  @@index([tenantId, parentId]) // Index lọc danh mục gốc/con của Tenant
  @@index([tenantId, createdAt(sort: Desc)]) // Sắp xếp danh mục mới nhất
}

model Brand {
  id        String    @id @default(uuid()) // ID Thương hiệu
  name      String // Tên thương hiệu (VD: Samsung, Apple)
  createdAt DateTime  @default(now()) // Thời gian tạo
  updatedAt DateTime  @updatedAt // Thời gian cập nhật
  deletedAt DateTime? // Xóa mềm
  imageUrl  String? // Logo thương hiệu (Legacy)
  imageId   String?
  image     Media?    @relation(fields: [imageId], references: [id])

  products Product[] // Danh sách sản phẩm thuộc thương hiệu

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, name]) // Tên thương hiệu duy nhất/Tenant
  @@unique([id, tenantId]) // Bảo mật ID
  @@index([tenantId]) // Index theo Tenant
  @@index([tenantId, createdAt(sort: Desc)]) // Sắp xếp
}

model Product {
  id              String              @id @default(uuid()) // ID sản phẩm
  name            String              @db.VarChar(255) // Tên sản phẩm, giới hạn 255 ký tự
  slug            String              @db.VarChar(255) // Slug URL thân thiện
  description     String? // Mô tả chi tiết (HTML hoặc Markdown)
  brandId         String // ID của thương hiệu
  categories      ProductToCategory[] // Các danh mục chứa sản phẩm này
  metadata        Json? // Dữ liệu mở rộng (Custom attributes)
  createdAt       DateTime            @default(now()) // Ngày tạo
  updatedAt       DateTime            @updatedAt // Ngày cập nhật
  deletedAt       DateTime? // Ngày xóa mềm (nếu null là đang active)
  metaDescription String? // SEO: Mô tả ngắn
  metaKeywords    String? // SEO: Từ khóa
  metaTitle       String? // SEO: Tiêu đề trang
  maxPrice        Decimal?            @db.Decimal(20, 2) // Giá cao nhất (của biến thể) - dùng cho filter
  minPrice        Decimal?            @db.Decimal(20, 2) // Giá thấp nhất (của biến thể) - hiển thị "Từ X đ"
  avgRating       Float?              @default(0) // Điểm đánh giá trung bình
  reviewCount     Int                 @default(0) // Tổng số lượt đánh giá
  commissionRate  Decimal             @default(0) @db.Decimal(5, 2) // Tỷ lệ hoa hồng mặc định cho sản phẩm này (%)

  // Vector Embedding (768 dimensions for Gemini text-embedding-004)
  // Requires pgvector extension. Enable if available.
  // embedding       Unsupported("vector(768)")? // Dùng cho tìm kiếm AI (Semantic Search)

  products     BlogProduct[] // Được nhắc tới trong bài Blog nào
  brand        Brand                @relation(fields: [brandId], references: [id]) // Link tới Brand
  images       ProductImage[] // Danh sách ảnh sản phẩm
  options      ProductOption[] // Các tùy chọn (Màu, Size...)
  translations ProductTranslation[] // Đa ngôn ngữ
  reviews      Review[] // Các review của sản phẩm
  skus         Sku[] // Danh sách biến thể (SKU)
  wishlists    Wishlist[] // Ai đã like sản phẩm này

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  // ============================================================
  // PERFORMANCE INDEXES (Production-ready)
  // ============================================================

  // 5. Slug Lookup (already unique, optimized by default)
  // No need for additional index

  @@unique([tenantId, slug])
  @@unique([id, tenantId])
  // 1. Brand + Price Range Filter
  // Covers: WHERE brandId = Y AND minPrice >= A AND maxPrice <= B
  @@index([brandId, minPrice, maxPrice, createdAt(sort: Desc)], name: "idx_product_brand_price")
  // 2. Price Range (25% of queries)
  // Covers: WHERE minPrice >= A ORDER BY createdAt DESC
  @@index([minPrice, maxPrice, createdAt(sort: Desc)], name: "idx_product_price_range")
  // 3. Brand Filter (15% of queries)
  // Covers: WHERE brandId = X ORDER BY createdAt DESC
  @@index([brandId, createdAt(sort: Desc)], name: "idx_product_brand_created")
  // 4. Price Sorting (10% of queries)
  // Covers: ORDER BY minPrice ASC/DESC
  @@index([minPrice, createdAt(sort: Desc)], name: "idx_product_price_asc")
  @@index([maxPrice(sort: Desc), createdAt(sort: Desc)], name: "idx_product_price_desc")
  // 6. Active Products Filter (80% of queries need this)
  // Partial index: WHERE deletedAt IS NULL
  @@index([deletedAt, createdAt(sort: Desc)], name: "idx_product_active")
  // 7. Rating Filter (for "top rated" queries)
  // Covers: WHERE avgRating >= 4 ORDER BY avgRating DESC
  @@index([avgRating(sort: Desc), reviewCount(sort: Desc)], name: "idx_product_rating")
  // 8. Search Optimization (B-tree indexing for common searches)
  @@index([name]) // Tìm theo tên
  @@index([description]) // Tìm trong mô tả (Full-text search sẽ tốt hơn)
  @@index([metadata], type: Gin) // Tìm trong JSON metadata
  // Legacy indexes (keep for backward compatibility, will remove in next version)
  // No duplicate name index here
  @@index([slug])
  @@index([deletedAt])
  @@index([tenantId])
  @@index([tenantId, deletedAt])
  @@index([tenantId, brandId, deletedAt])
  @@index([tenantId, minPrice, maxPrice, deletedAt])
  @@index([tenantId, deletedAt, createdAt]) // For Storefront listings
}

model ProductToCategory {
  productId  String // ID Sản phẩm
  categoryId String // ID Danh mục
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId]) // Khóa chính kết hợp
  @@index([categoryId]) // Index lọc sản phẩm theo danh mục
  @@index([productId]) // Index xem sản phẩm thuộc danh mục nào
}

model ProductOption {
  id           String        @id @default(uuid()) // ID tùy chọn (VD: Màu sắc)
  name         String        @db.VarChar(50) // Tên tùy chọn
  displayOrder Int? // Thứ tự hiển thị
  productId    String // ID sản phẩm
  values       OptionValue[] // Danh sách các giá trị (Đỏ, Xanh...)
  product      Product       @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId]) // Index theo sản phẩm
}

model OptionValue {
  id       String  @id @default(uuid()) // ID giá trị tùy chọn
  value    String  @db.VarChar(50) // Giá trị (VD: Đỏ)
  imageUrl String? // Ảnh đại diện cho giá trị này (Legacy)
  imageId  String?
  image    Media?  @relation(fields: [imageId], references: [id])

  optionId    String // ID tùy chọn
  option      ProductOption      @relation(fields: [optionId], references: [id], onDelete: Cascade)
  skuVariants SkuToOptionValue[] // Các SKU sử dụng giá trị này

  @@index([optionId]) // Index theo option
}

model Sku {
  id             String             @id @default(uuid()) // ID SKU (Đơn vị lưu kho)
  skuCode        String             @db.VarChar(50) // Mã SKU quản lý (VD: IPHONE-13-RED-64)
  productId      String // ID sản phẩm cha
  price          Decimal?           @db.Decimal(20, 2) // Giá bán thường
  salePrice      Decimal?           @db.Decimal(20, 2) // Giá khuyến mãi
  stock          Int                @default(0) // Số lượng tồn kho (Deprecated: Use InventoryItem)
  imageUrl       String? // Ảnh riêng của SKU này
  status         String             @default("INACTIVE") // Trạng thái (ACTIVE, INACTIVE)
  metadata       Json? // Dữ liệu thêm
  createdAt      DateTime           @default(now()) // Ngày tạo
  updatedAt      DateTime           @updatedAt // Ngày cập nhật
  reservedStock  Int                @default(0) // Tồn kho đang được giữ (trong đơn hàng chưa thanh toán)
  cartItems      CartItem[] // Các giỏ hàng đang chứa SKU này
  inventoryLogs  InventoryLog[] // Lịch sử biến động kho
  inventoryItems InventoryItem[] // Đa kho hàng
  orderItems     OrderItem[] // Các đơn hàng đã mua SKU này
  reviews        Review[] // Review cụ thể cho SKU này
  optionValues   SkuToOptionValue[] // Các giá trị tùy chọn (Màu Đỏ, 64GB) tạo nên SKU này
  priceListItems PriceListItem[]
  images         SkuImage[] // Ảnh chi tiết SKU
  product        Product            @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, skuCode]) // Mã SKU duy nhất trong Tenant
  @@unique([id, tenantId]) // Bảo mật ID
  @@index([productId]) // Index theo sản phẩm cha
  @@index([skuCode]) // Tìm theo mã SKU
  @@index([tenantId]) // Lọc theo Tenant
  @@index([metadata], type: Gin) // Tìm trong metadata
  @@index([tenantId, productId, status]) // Lọc SKU active của sản phẩm
}

model Warehouse {
  id             String          @id @default(uuid())
  name           String // Tên kho (Kho HCM, Kho HN)
  address        String? // Địa chỉ kho
  isDefault      Boolean         @default(false) // Là kho mặc định?
  tenantId       String
  tenant         Tenant          @relation(fields: [tenantId], references: [id])
  inventoryItems InventoryItem[]

  createdAt DateTime @default(now()) // Ngày tạo
  updatedAt DateTime @updatedAt // Ngày cập nhật

  @@index([tenantId])
}

model InventoryItem {
  id          String @id @default(uuid())
  warehouseId String
  skuId       String
  quantity    Int    @default(0)

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  sku       Sku       @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, skuId])
  @@index([skuId])
}

model SkuToOptionValue {
  skuId         String // ID SKU
  optionValueId String // ID Giá trị tùy chọn
  optionValue   OptionValue @relation(fields: [optionValueId], references: [id], onDelete: Cascade)
  sku           Sku         @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@id([skuId, optionValueId]) // Khóa chính kết hợp
}

model Address {
  id            String   @id @default(uuid()) // ID địa chỉ
  userId        String // ID người dùng sở hữu
  isDefault     Boolean  @default(false) // Có phải địa chỉ mặc định không
  recipientName String // Tên người nhận
  phoneNumber   String // Số điện thoại người nhận
  street        String // Địa chỉ chi tiết (Số nhà, đường)
  city          String // Tỉnh/Thành phố
  district      String // Quận/Huyện
  ward          String? // Phường/Xã
  postalCode    String? // Mã bưu điện
  country       String?  @db.VarChar(100) // Quốc gia
  createdAt     DateTime @default(now()) // Ngày tạo
  updatedAt     DateTime @updatedAt // Ngày cập nhật
  districtId    Int? // ID Quận/Huyện (cho tích hợp GHN/GHTK)
  provinceId    Int? // ID Tỉnh/Thành (cho tích hợp GHN/GHTK)
  wardCode      String? // Mã Phường/Xã (cho tích hợp GHN/GHTK)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  orders Order[] // Các đơn hàng dùng địa chỉ này

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@index([userId]) // Lọc địa chỉ theo User
  @@index([tenantId]) // Lọc theo Tenant
}

model Cart {
  id        String     @id @default(uuid()) // ID Giỏ hàng
  userId    String // ID User sở hữu
  createdAt DateTime   @default(now()) // Ngày tạo
  updatedAt DateTime   @updatedAt // Ngày cập nhật
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[] // Danh sách sản phẩm trong giỏ

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([userId, tenantId]) // Mỗi user chỉ có 1 giỏ hàng trong 1 Tenant
}

model CartItem {
  id        String   @id @default(uuid()) // ID mục trong giỏ
  cartId    String // ID Giỏ hàng
  skuId     String // ID SKU sản phẩm
  quantity  Int      @default(1) // Số lượng mua
  createdAt DateTime @default(now()) // Ngày thêm vào
  updatedAt DateTime @updatedAt // Ngày cập nhật
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  sku       Sku      @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@unique([cartId, skuId]) // Trong 1 giỏ, một SKU chỉ xuất hiện 1 dòng
  @@index([skuId]) // Tham chiếu ngược
}

// =====================================================================
// PROMOTION ENGINE (Advanced)
// =====================================================================

model Promotion {
  id          String  @id @default(uuid())
  name        String // Tên chương trình
  code        String? // Mã nhập (nếu có)
  description String?

  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(true) // Trạng thái kích hoạt
  priority  Int      @default(0) // Độ ưu tiên (Số càng lớn càng ưu tiên cao)

  usageLimit Int? // Giới hạn số lần sử dụng tổng cộng
  usedCount  Int  @default(0) // Số lần đã sử dụng

  // Rules & Actions
  rules   PromotionRule[]
  actions PromotionAction[]
  usages  PromotionUsage[]

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  createdAt DateTime @default(now()) // Ngày tạo
  updatedAt DateTime @updatedAt // Ngày cập nhật

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
  @@index([startDate, endDate]) // Index cho tìm kiếm theo khoảng thời gian
}

model PromotionRule {
  id          String @id @default(uuid())
  promotionId String
  type        String // Loại điều kiện (MIN_ORDER_VALUE, SPECIFIC_CATEGORY, CUSTOMER_GROUP...)
  operator    String // Toán tử so sánh (GTE, EQ, IN...)
  value       String // Giá trị so sánh (VD: "500000", "cat_123", "vip_group")

  promotion Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@index([promotionId]) // Index Foreign Key
}

model PromotionAction {
  id                String   @id @default(uuid())
  promotionId       String
  type              String // Loại hành động (DISCOUNT_FIXED, DISCOUNT_PERCENT, FREE_SHIPPING, GIFT...)
  value             String // Giá trị giảm (VD: "50000", "10")
  maxDiscountAmount Decimal? @db.Decimal(20, 2) // Số tiền giảm tối đa (cho loại %)

  promotion Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@index([promotionId]) // Index Foreign Key
}

model PromotionUsage {
  id             String  @id @default(uuid())
  promotionId    String
  userId         String
  orderId        String // Link to Order
  discountAmount Decimal @db.Decimal(20, 2)

  promotion Promotion @relation(fields: [promotionId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
  order     Order     @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())

  @@index([promotionId])
  @@index([userId])
  @@index([orderId])
}

model Order {
  id                        String                  @id @default(uuid()) // ID Đơn hàng
  userId                    String // ID Người mua
  status                    OrderStatus             @default(PENDING) // Trạng thái đơn hàng
  totalAmount               Decimal                 @db.Decimal(20, 2) // Tổng tiền
  shippingFee               Decimal                 @default(0.00) @db.Decimal(20, 2) // Phí vận chuyển
  recipientName             String // Tên người nhận
  phoneNumber               String // SĐT người nhận
  shippingAddress           String? // Địa chỉ giao hàng (Text)
  shippingCity              String? // Thành phố
  shippingDistrict          String? // Quận/Huyện
  shippingWard              String? // Phường/Xã
  shippingPhone             String? // SĐT giao hàng (nếu khác)
  shippingAddressSnapshot   Json? // Snapshot địa chỉ đầy đủ lúc đặt (tránh user sửa address sau này làm sai data đơn cũ)
  paymentMethod             String? // Phương thức thanh toán (COD, MOMO...)
  paymentStatus             PaymentStatus           @default(UNPAID) // Trạng thái thanh toán
  transactionId             String? // Mã giao dịch (Legacy)
  payments                  Payment[] // Lịch sử thanh toán chi tiết
  orderDate                 DateTime                @default(now()) // Ngày đặt hàng
  updatedAt                 DateTime                @updatedAt // Ngày cập nhật
  createdAt                 DateTime                @default(now()) // Ngày tạo bản ghi
  deletedAt                 DateTime? // Xóa mềm
  referredByBlogId          String? // ID bài viết giới thiệu dẫn đến đơn hàng này
  platformFeeAmount         Decimal?                @db.Decimal(20, 2) // Số tiền phí sàn thu từ tenant cho đơn này
  affiliateCommissionAmount Decimal?                @db.Decimal(20, 2) // Số tiền hoa hồng trả cho người viết blog
  commissionTransactions    CommissionTransaction[]

  // Promotion (New)
  promotions PromotionUsage[] // Các khuyến mãi đã áp dụng

  // Legacy Coupon (Keep for backward compatibility during migration)
  couponId String? // Mã giảm giá đã dùng
  coupon   Coupon? @relation(fields: [couponId], references: [id])

  addressId            String? // ID địa chỉ đã chọn
  shippingCode         String? // Mã vận đơn
  ghnStatus            String? // Trạng thái từ GHN/GHTK
  expectedDeliveryTime DateTime? // Thời gian giao hàng dự kiến
  cancellationReason   String? // Lý do hủy đơn

  // Return Request (New)
  returnRequests ReturnRequest[]

  // coupon                  Coupon?       @relation(fields: [couponId], references: [id]) // Relation removed due to model removal
  address Address?    @relation(fields: [addressId], references: [id])
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items   OrderItem[] // Danh sách sản phẩm trong đơn

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  referredByBlog Blog? @relation("BlogReferrals", fields: [referredByBlogId], references: [id])

  // ============================================================
  // PERFORMANCE INDEXES (Production-ready)
  // ============================================================

  @@unique([id, tenantId])
  @@index([couponId])
  // 1. User Order History (50% of queries)
  // Covers: WHERE userId = X ORDER BY createdAt DESC
  @@index([userId, createdAt(sort: Desc)], name: "idx_order_user_history")
  // 2. User + Status Filter (30% of queries)
  // Covers: WHERE userId = X AND status IN ('PENDING', 'PROCESSING')
  @@index([userId, status, createdAt(sort: Desc)], name: "idx_order_user_status")
  // 3. Admin Dashboard (15% of queries)
  // Covers: WHERE status = 'PENDING' ORDER BY createdAt DESC
  @@index([status, createdAt(sort: Desc)], name: "idx_order_status_date")
  // 4. Payment Status Filter (5% of queries)
  // Covers: WHERE paymentStatus = 'UNPAID' AND createdAt < X (for auto-cancel)
  @@index([paymentStatus, createdAt], name: "idx_order_payment_created")
  // 5. Shipping Code Lookup
  @@index([shippingCode], name: "idx_order_shipping_code")
  @@index([tenantId])
  @@index([tenantId, status, createdAt]) // For Tenant Admin Dashboard
}

// =====================================================================
// RMA - RETURN MERCHANDISE AUTHORIZATION
// =====================================================================

model ReturnRequest {
  id           String       @id @default(uuid())
  orderId      String
  userId       String
  status       ReturnStatus @default(PENDING) // Trạng thái yêu cầu
  reason       String // Lý do đổi trả
  description  String? // Mô tả chi tiết
  refundAmount Decimal?     @db.Decimal(20, 2) // Số tiền hoàn lại dự kiến
  images       String[] // Danh sách ảnh bằng chứng

  tenantId String
  tenant   Tenant       @relation(fields: [tenantId], references: [id])
  order    Order        @relation(fields: [orderId], references: [id])
  user     User         @relation(fields: [userId], references: [id])
  items    ReturnItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([userId])
  @@index([tenantId])
  @@index([status]) // Thêm index trạng thái để lọc nhanh
}

model ReturnItem {
  id              String @id @default(uuid())
  returnRequestId String
  orderItemId     String
  quantity        Int

  returnRequest ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)
  // Link to order item if needed, mainly logical

  @@index([returnRequestId]) // Index Foreign Key
}

enum ReturnStatus {
  PENDING
  APPROVED
  RECEIVED
  REFUNDED
  REJECTED
  CANCELLED
}

model OrderItem {
  id              String  @id @default(uuid()) // ID dòng chi tiết đơn hàng
  orderId         String // ID Đơn hàng
  skuId           String // ID SKU
  quantity        Int // Số lượng mua
  priceAtPurchase Decimal @db.Decimal(20, 2) // Giá tại thời điểm mua (quan trọng để không bị đổi khi giá gốc đổi)
  order           Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sku             Sku     @relation(fields: [skuId], references: [id])

  // Denormalized Data for Historial Integrity & Performance
  productName     String? // Tên sản phẩm lúc mua (Lưu cứng)
  skuNameSnapshot String? // Tên SKU lúc mua (Lưu cứng)
  productSlug     String? // Slug lúc mua
  imageUrl        String? // Ảnh lúc mua

  @@unique([orderId, skuId]) // Một SKU chỉ xuất hiện 1 lần trong đơn
  @@index([skuId]) // Tham chiếu
}

model Review {
  id         String    @id @default(uuid()) // ID đánh giá
  userId     String // ID người đánh giá
  productId  String // ID sản phẩm được đánh giá
  rating     Int       @db.SmallInt // Số sao (1-5)
  content    String? // Nội dung đánh giá
  isApproved Boolean   @default(false) // Trạng thái duyệt (chống spam)
  createdAt  DateTime  @default(now()) // Ngày đánh giá
  updatedAt  DateTime  @updatedAt // Ngày cập nhật
  deletedAt  DateTime? // Xóa mềm
  skuId      String? // Review cho biến thể nào
  images     String[] // Ảnh đính kèm
  reply      String? // Phản hồi của shop
  replyAt    DateTime? // Thời gian phản hồi
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku        Sku?      @relation(fields: [skuId], references: [id])
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenancy (Đa cửa hàng) - Mỗi review thuộc về một tenant cụ thể
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  // AI Analysis
  sentiment Sentiment? // Cảm xúc tích cực/tiêu cực (AI phân tích)
  autoTags  String[] // Tag tự động (VD: ["shipping_issue", "product_quality", "service"])

  @@unique([userId, productId, skuId]) // Mỗi user chỉ đánh giá 1 lần/SKU
  @@index([productId, rating]) // Lọc review theo sao
  @@index([skuId])
  @@index([tenantId])
  @@index([tenantId, productId, isApproved, createdAt(sort: Desc)]) // Lấy review hiển thị cho khách
  @@index([sentiment])
}

enum Sentiment {
  POSITIVE // Tích cực
  NEGATIVE // Tiêu cực
  NEUTRAL // Trung tính
}

// Bảng lưu nhật ký hoạt động (Audit Log)
// Strategy: Partitioning by Month (Native Postgres)
// This table should be converted to a partitioned table in migration.
model AuditLog {
  id        String   @default(uuid()) // ID định danh log
  userId    String? // ID người thực hiện hành động (có thể null nếu là system/anonymous)
  action    String // Tên hành động (VD: "CREATE_PRODUCT", "DELETE_ORDER", "LOGIN")
  resource  String // Tài nguyên bị tác động (VD: "Product", "Order", "System")
  payload   Json? // Chi tiết dữ liệu thay đổi (Lưu snapshot dữ liệu cũ/mới để so sánh)
  ipAddress String? // Địa chỉ IP của người thực hiện
  userAgent String? // Thông tin trình duyệt/thiết bị của người thực hiện
  createdAt DateTime @default(now()) // Thời điểm ghi log

  user User? @relation(fields: [userId], references: [id]) // Link tới bảng User để biết ai làm

  // Composite ID is REQUIRED for time-based partitioning in Prisma/Postgres
  @@id([id, createdAt])
  @@index([userId])
  @@index([resource])
  @@index([action])
  @@index([payload], type: Gin)
}

model ProductTranslation {
  id          String  @id @default(uuid()) // ID
  productId   String // ID sản phẩm
  locale      String // Ngôn ngữ (en, vi...)
  name        String  @db.VarChar(255) // Tên dịch
  description String? // Mô tả dịch
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale]) // Mỗi sản phẩm chỉ có 1 bản dịch cho 1 ngôn ngữ
  @@index([productId])
  @@index([locale])
}

model ProductImage {
  id      String  @id @default(uuid()) // ID ảnh
  url     String // URL ảnh (Legacy or Direct Link)
  mediaId String?

  alt          String? // Văn bản thay thế (SEO)
  displayOrder Int     @default(0) // Thứ tự hiển thị
  productId    String // ID sản phẩm

  media   Media?  @relation(fields: [mediaId], references: [id])
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model SkuImage {
  id      String  @id @default(uuid()) // ID ảnh biến thể
  url     String // URL ảnh
  mediaId String?

  alt          String? // SEO
  displayOrder Int     @default(0) // Thứ tự
  skuId        String // ID SKU

  media Media? @relation(fields: [mediaId], references: [id])
  sku   Sku    @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@index([skuId])
}

model Notification {
  id        String   @id @default(uuid()) // ID thông báo
  type      String // Loại (ORDER_UPDATE, PROMOTION...)
  title     String // Tiêu đề
  message   String // Nội dung
  isRead    Boolean  @default(false) // Đã đọc chưa
  link      String? // Link điều hướng khi click
  createdAt DateTime @default(now()) // Ngày tạo
  userId    String // Người nhận
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
}

model InventoryLog {
  id            String   @id @default(uuid()) // ID log kho
  skuId         String // ID SKU
  changeAmount  Int // Số lượng thay đổi (+ nhập, - xuất)
  previousStock Int // Tồn trước khi đổi
  newStock      Int // Tồn sau khi đổi
  reason        String // Lý do (Nhập hàng, Bán hàng, Hoàn trả...)
  userId        String? // Người thực hiện
  createdAt     DateTime @default(now()) // Ngày ghi
  sku           Sku      @relation(fields: [skuId], references: [id], onDelete: Cascade)
  user          User?    @relation(fields: [userId], references: [id])

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@index([skuId])
  @@index([userId])
  @@index([tenantId])
}

model Wishlist {
  id        String   @id @default(uuid()) // ID bản ghi yêu thích
  userId    String // ID User
  productId String // ID Sản phẩm
  createdAt DateTime @default(now()) // Ngày like
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([userId, productId]) // User chỉ like 1 lần/sp
  @@index([userId])
  @@index([tenantId])
  @@index([tenantId, userId, createdAt(sort: Desc)])
}

model Blog {
  id        String  @id @default(uuid()) // ID bài viết
  title     String  @db.VarChar(255) // Tiêu đề
  slug      String  @db.VarChar(255) // URL thân thiện
  excerpt   String // Đoạn trích dẫn ngắn
  content   String // Nội dung bài viết (HTML)
  image     String? @db.VarChar(500) // Ảnh đại diện bài viết (Legacy)
  imageId   String?
  blogMedia Media?  @relation(fields: [imageId], references: [id])

  category       String        @db.VarChar(100) // Danh mục bài viết
  author         String        @db.VarChar(100) // Tác giả
  language       String        @default("en") @db.VarChar(5) // Ngôn ngữ
  readTime       String?       @db.VarChar(20) // Thời gian đọc ước tính
  publishedAt    DateTime? // Ngày xuất bản
  createdAt      DateTime      @default(now()) // Ngày tạo
  updatedAt      DateTime      @updatedAt // Cập nhật
  deletedAt      DateTime? // Xóa mềm
  userId         String? // Người viết
  user           User?         @relation(fields: [userId], references: [id])
  products       BlogProduct[] // Các sản phẩm được nhắc đến
  referredOrders Order[]       @relation("BlogReferrals") // Các đơn hàng được giới thiệu từ bài viết này

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, slug])
  @@index([slug])
  @@index([tenantId])
  @@index([tenantId, category])
  @@index([tenantId, publishedAt(sort: Desc)])
  @@index([category])
  @@index([language])
  @@index([publishedAt])
  @@index([userId])
  @@index([deletedAt])
}

model BlogProduct {
  blogId    String
  productId String
  createdAt DateTime @default(now())
  blog      Blog     @relation(fields: [blogId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([blogId, productId])
  @@index([blogId])
  @@index([productId])
}

model FeatureFlag {
  id          String   @id @default(uuid()) // ID cờ tính năng
  key         String   @unique // Khóa định danh (VD: NEW_CHECKOUT_FLOW)
  description String? // Mô tả
  isEnabled   Boolean  @default(false) // Bật/Tắt
  rules       Json? // Quy tắc áp dụng (VD: chỉ bật cho user beta)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@index([key])
  @@index([tenantId])
}

enum OrderStatus {
  PENDING // Chờ xử lý
  PROCESSING // Đang xử lý
  SHIPPED // Đang giao hàng
  DELIVERED // Đã giao hàng
  CANCELLED // Đã hủy
  RETURNED // Đã trả hàng
}

enum PaymentStatus {
  UNPAID // Chưa thanh toán
  PENDING // Đang chờ thanh toán
  PAID // Đã thanh toán
  FAILED // Thanh toán thất bại
  REFUNDED // Đã hoàn tiền
}

enum DiscountType {
  PERCENTAGE // Giảm theo %
  FIXED_AMOUNT // Giảm số tiền cố định
}

model Payment {
  id                    String        @id @default(uuid()) // ID bản ghi thanh toán
  orderId               String // ID Đơn hàng
  amount                Decimal       @db.Decimal(20, 2) // Số tiền thanh toán
  currency              String        @default("VND") // Đơn vị tiền tệ
  status                PaymentStatus @default(PENDING) // Trạng thái
  paymentMethod         String // Phương thức (MOMO, VNPAY, STRIPE, COD)
  providerTransactionId String? // ID từ phía cổng thanh toán (VD: Mã giao dịch Momo)
  metadata              Json? // Lưu log response từ Gateway (để debug)
  paidAt                DateTime? // Thời điểm thanh toán thành công
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([tenantId])
}

model NewsletterSubscriber {
  id        String   @id @default(uuid()) // ID người đăng ký
  email     String // Email
  isActive  Boolean  @default(true) // Còn đăng ký không
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, email])
  @@index([email])
  @@index([tenantId])
}

model ChatConversation {
  id        String        @id @default(uuid()) // ID hội thoại
  userId    String // ID khách hàng
  isActive  Boolean       @default(true) // Đang hoạt động
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  user      User          @relation(fields: [userId], references: [id])
  messages  ChatMessage[] // Các tin nhắn

  @@unique([userId])
  @@index([userId])
  @@index([updatedAt])
}

model ChatMessage {
  id             String           @id @default(uuid()) // ID tin nhắn
  conversationId String // ID hội thoại
  senderId       String // ID người gửi
  senderType     SenderType       @default(USER) // Loại người gửi (Admin/User)
  content        String // Nội dung tin nhắn
  type           MessageType      @default(TEXT) // Loại tin (Text, Ảnh, Sản phẩm)
  metadata       Json? // Dữ liệu đính kèm
  isRead         Boolean          @default(false) // Đã đọc chưa
  sentAt         DateTime         @default(now()) // Thời gian gửi
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([sentAt])
}

enum SenderType {
  USER // Khách hàng
  ADMIN // Quản trị viên
}

enum MessageType {
  TEXT // Văn bản
  IMAGE // Hình ảnh
  PRODUCT // Gửi sản phẩm tư vấn
  ORDER // Gửi thông tin đơn hàng
}

model PerformanceMetric {
  id             String   @default(uuid())
  name           String // Tên chỉ số (LCP, FID, CLS, FCP, TTFB, INP)
  value          Float // Giá trị đo được
  rating         String // Xếp hạng (good, needs-improvement, poor)
  url            String // URL trang web đo
  userAgent      String? // Trình duyệt của user
  navigationType String? // Kiểu điều hướng (navigate, reload...)
  createdAt      DateTime @default(now())

  @@id([id, createdAt])
  @@index([name])
  @@index([createdAt])
}

// =====================================================================
// AI CHAT - Tính năng chat với AI sử dụng Google Gemini
// =====================================================================

model AiChatSession {
  id        String          @id @default(uuid()) // ID phiên chat
  userId    String? // ID User (nếu đã đăng nhập)
  guestId   String? // UUID lưu local storage (nếu là khách)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  messages  AiChatMessage[] // Danh sách tin nhắn

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([guestId])
  @@index([createdAt])
}

model AiChatMessage {
  id        String     @id @default(uuid()) // ID tin nhắn
  sessionId String // ID phiên chat
  role      AiChatRole // Vai trò (Người dùng / Trợ lý ảo)
  content   String     @db.Text // Nội dung chat (có thể dài)
  metadata  Json? // Metadata (sản phẩm gợi ý, tokens...)
  createdAt DateTime   @default(now())

  session AiChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
}

enum AiChatRole {
  USER // Người dùng
  ASSISTANT // Trợ lý ảo
}

// =====================================================================
// RELIABILITY - Transactional Outbox Pattern
// =====================================================================

model OutboxEvent {
  id            String       @id @default(uuid())
  aggregateType String // Loại đối tượng (VD: "ORDER")
  aggregateId   String // ID đối tượng (VD: Order ID)
  type          String // Loại sự kiện (VD: "ORDER_CREATED")
  payload       Json // Dữ liệu sự kiện
  createdAt     DateTime     @default(now())
  processedAt   DateTime? // Thời gian xử lý xong
  status        OutboxStatus @default(PENDING) // Trạng thái
  error         String? // Lỗi nếu có

  @@index([status, createdAt])
}

enum OutboxStatus {
  PENDING // Chưa xử lý
  PROCESSING // Đang xử lý
  COMPLETED // Đã xong
  FAILED // Thất bại
}

// =====================================================================
// MULTI-TENANCY
// =====================================================================

model Tenant {
  id      String  @id @default(uuid()) // ID định danh Tenant (Cửa hàng)
  name    String // Tên cửa hàng
  ownerId String?
  owner   User?   @relation("TenantOwner", fields: [ownerId], references: [id])
  coupons Coupon[]

  // Domain Management
  subdomain    String? @unique // Subdomain hệ thống (shop-a.platform.com)
  customDomain String? @unique // Tên miền riêng (mycustomstore.com)
  domain       String  @unique // Domain chính (để định tuyến)

  // Settings & Localization
  currency String @default("VND") // Đơn vị tiền tệ chính
  timezone String @default("Asia/Ho_Chi_Minh") // Múi giờ mặc định
  locale   String @default("vi-VN") // Ngôn ngữ/Vùng mặc định

  // Branding & Assets
  themeConfig Json? // Cấu hình giao diện (Màu sắc, Font...)
  logoUrl     String? // Logo
  faviconUrl  String? // Favicon

  // Business Information
  contactEmail String? // Email liên hệ
  contactPhone String? // SĐT liên hệ
  address      String? // Địa chỉ kinh doanh

  // Lifecycle & Status
  plan             TenantPlan @default(BASIC) // Gói dịch vụ
  isActive         Boolean    @default(true) // Trạng thái hoạt động
  suspendedAt      DateTime? // Thời điểm bị treo
  suspensionReason String? // Lý do treo (nợ cước, vi phạm...)

  // Infrastructure
  dbUrl String? // URL Database riêng (Chế độ Silo)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users                 User[]
  products              Product[]
  orders                Order[]
  blogs                 Blog[]
  reviews               Review[]
  carts                 Cart[]
  wishlists             Wishlist[]
  addresses             Address[]
  inventoryLogs         InventoryLog[]
  featureFlags          FeatureFlag[]
  pages                 Page[]
  translations          Translation[]
  categories            Category[]
  brands                Brand[]
  payments              Payment[]
  skus                  Sku[]
  roles                 Role[]
  newsletterSubscribers NewsletterSubscriber[]

  // New features
  warehouses     Warehouse[]
  promotions     Promotion[]
  customerGroups CustomerGroup[]
  returnRequests ReturnRequest[]
  priceLists     PriceList[]
  media          Media[]

  // Analytics
  metrics StoreMetrics[]

  // Billing
  subscription Subscription?
  invoices     Invoice[]
}

model StoreMetrics {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  date           DateTime @default(now()) // Ngày thống kê
  totalOrders    Int      @default(0) // Tổng số đơn hàng
  totalRevenue   Decimal  @default(0) @db.Decimal(20, 2) // Tổng doanh thu (sau chiết khấu)
  totalVisits    Int      @default(0) // Tổng lượt truy cập
  conversionRate Float    @default(0) // Tỷ lệ chuyển đổi (%)

  @@unique([tenantId, date])
  @@index([tenantId])
}

model Translation {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  locale   String // Ngôn ngữ (en, vi)
  key      String // Khóa dịch (VD: home.welcome)
  value    String // Giá trị dịch (VD: "Chào mừng bạn")

  updatedAt DateTime @updatedAt

  @@unique([tenantId, locale, key])
  @@index([tenantId, locale])
}

enum TenantPlan {
  BASIC // Cơ bản
  PRO // Chuyên nghiệp
  ENTERPRISE // Doanh nghiệp lớn
}

model Page {
  id          String  @id @default(uuid()) // ID trang
  tenantId    String // ID Tenant
  tenant      Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  slug        String // URL (/, /about-us)
  title       String // Tiêu đề trang
  isPublished Boolean @default(true) // Trạng thái xuất bản

  // The magic: JSON-based Block Structure
  // [ { "type": "Hero", "props": { ... } }, { "type": "ProductGrid", "props": { ... } } ]
  blocks Json @default("[]") // Cấu trúc nội dung dạng khối (CMS)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([tenantId, slug]) // Slug duy nhất trong Tenant
  @@index([tenantId])
}

// =====================================================================
// BILLING & SUBSCRIPTIONS
// =====================================================================

model Subscription {
  id       String     @id @default(uuid())
  tenantId String     @unique // 1 Tenant chỉ có 1 Subscription active
  plan     TenantPlan // Gói hiện tại

  planId           String?
  subscriptionPlan SubscriptionPlan? @relation(fields: [planId], references: [id])

  billingFrequency  BillingFrequency @default(MONTHLY) // Chu kỳ thanh toán (Tháng/Năm)
  startDate         DateTime         @default(now()) // Ngày bắt đầu gói
  nextBillingDate   DateTime // Ngày thanh toán tiếp theo
  isActive          Boolean          @default(true) // Trạng thái gói (Đang hoạt động?)
  cancelAtPeriodEnd Boolean          @default(false) // Hủy gia hạn khi hết kỳ

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  invoices Invoice[] // Lịch sử hóa đơn

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id             String        @id @default(uuid()) // ID hóa đơn
  tenantId       String
  subscriptionId String?
  amount         Decimal       @db.Decimal(10, 2) // Số tiền thanh toán
  currency       String        @default("VND") // Đơn vị tiền tệ
  status         InvoiceStatus @default(PENDING) // Trạng thái hóa đơn
  description    String? // Mô tả chi tiết
  paidAt         DateTime? // Thời điểm thanh toán thành công
  dueDate        DateTime // Hạn chót thanh toán

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([status])
}

enum BillingFrequency {
  MONTHLY // Hàng tháng
  YEARLY // Hàng năm
}

enum InvoiceStatus {
  PENDING // Đang chờ thanh toán
  PAID // Đã thanh toán thành công
  OVERDUE // Quá hạn thanh toán
  CANCELLED // Đã hủy bỏ
  VOID // Vô hiệu hóa
}

model SubscriptionPlan {
  id          String  @id @default(uuid()) // ID gói
  name        String // Tên gói
  slug        String  @unique // Slug định danh
  description String? // Mô tả

  priceMonthly Decimal @default(0) @db.Decimal(10, 2) // Giá tháng
  priceYearly  Decimal @default(0) @db.Decimal(10, 2) // Giá năm
  currency     String  @default("USD") // Đơn vị tiền

  maxProducts    Int     @default(100) // Giới hạn số lượng sản phẩm
  maxStorage     Int     @default(1024) // Giới hạn dung lượng lưu trữ (MB)
  transactionFee Decimal @default(0.0) @db.Decimal(5, 2) // Phí giao dịch sàn (%)

  features Json? @default("[]") // Danh sách tính năng (JSON)

  isActive Boolean @default(true) // Trạng thái đang bán
  isPublic Boolean @default(true) // Hiển thị công khai trên bảng giá

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]
}

model CommissionTransaction {
  id        String           @id @default(uuid())
  userId    String // Người nhận hoa hồng
  orderId   String? // Đơn hàng liên quan (nếu có)
  amount    Decimal          @db.Decimal(20, 2)
  type      CommissionType
  status    CommissionStatus @default(COMPLETED)
  note      String?
  createdAt DateTime         @default(now())

  user  User   @relation(fields: [userId], references: [id])
  order Order? @relation(fields: [orderId], references: [id])
}

enum CommissionType {
  DIRECT_REFERRAL // Hoa hồng trực tiếp từ blog/link
  SUBSCRIPTION_FEE // Phí sàn từ gói thuê của tenant
  TIER_2_REFERRAL // Hoa hồng cấp 2
  WITHDRAWAL // Rút tiền
}

enum CommissionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

model Coupon {
  id                String       @id @default(uuid())
  code              String
  description       String?
  discountType      DiscountType
  discountValue     Decimal      @db.Decimal(20, 2)
  minOrderAmount    Decimal?     @db.Decimal(20, 2)
  maxDiscountAmount Decimal?     @db.Decimal(20, 2)
  startDate         DateTime
  endDate           DateTime
  usageLimit        Int?
  usedCount         Int          @default(0)
  isActive          Boolean      @default(true)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  tenantId          String
  tenant            Tenant       @relation(fields: [tenantId], references: [id])
  orders            Order[]

  @@unique([code, tenantId])
  @@index([tenantId])
}
