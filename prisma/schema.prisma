generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                  @id @default(uuid())
  email                  String
  firstName              String?
  lastName               String?
  password               String?                 @db.VarChar(255)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  avatarUrl              String?
  provider               String?
  socialId               String?
  twoFactorEnabled       Boolean                 @default(false)
  twoFactorSecret        String?
  tenantId               String
  deletedAt              DateTime?
  whitelistedIps         Json?                   @default("[]")
  avatarId               String?
  customerGroupId        String?
  commissionBalance      Decimal                 @default(0) @db.Decimal(20, 2)
  referredByUserId       String?
  addresses              Address[]
  aiChatSessions         AiChatSession[]
  auditLogs              AuditLog[]
  blogs                  Blog[]
  carts                  Cart[]
  conversations          ChatConversation?
  commissionTransactions CommissionTransaction[]
  inventoryLogs          InventoryLog[]
  loyaltyPoints          LoyaltyPoint[]
  notifications          Notification[]
  orders                 Order[]
  promotions             PromotionUsage[]
  returnRequests         ReturnRequest[]
  reviews                Review[]
  ownedTenants           Tenant[]                @relation("TenantOwner")
  avatar                 Media?                  @relation(fields: [avatarId], references: [id])
  customerGroup          CustomerGroup?          @relation(fields: [customerGroupId], references: [id])
  referredByUser         User?                   @relation("UserReferrals", fields: [referredByUserId], references: [id])
  referrals              User[]                  @relation("UserReferrals")
  tenant                 Tenant                  @relation(fields: [tenantId], references: [id])
  permissions            UserPermission[]
  roles                  UserRole[]
  wishlist               Wishlist[]

  @@unique([tenantId, email])
  @@unique([id, tenantId])
  @@index([email])
  @@index([tenantId])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([customerGroupId])
}

model Media {
  id            String         @id @default(uuid())
  url           String         @db.VarChar(2048)
  type          String         @db.VarChar(50)
  mimeType      String?        @db.VarChar(100)
  fileName      String?        @db.VarChar(255)
  altText       String?        @db.VarChar(255)
  size          Int?
  width         Int?
  height        Int?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  tenantId      String
  blogs         Blog[]
  brands        Brand[]
  categories    Category[]
  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  optionValues  OptionValue[]
  productImages ProductImage[]
  skuImages     SkuImage[]
  users         User[]

  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, createdAt(sort: Desc)])
}

model CustomerGroup {
  id          String     @id @default(uuid())
  name        String
  description String?
  tenantId    String
  priceListId String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  priceList   PriceList? @relation(fields: [priceListId], references: [id])
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  users       User[]

  @@unique([tenantId, name])
  @@index([priceListId])
}

model PriceList {
  id             String          @id @default(uuid())
  name           String
  currency       String          @default("VND")
  isDefault      Boolean         @default(false)
  startDate      DateTime?
  endDate        DateTime?
  isActive       Boolean         @default(true)
  tenantId       String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  customerGroups CustomerGroup[]
  tenant         Tenant          @relation(fields: [tenantId], references: [id])
  items          PriceListItem[]

  @@index([tenantId])
}

model PriceListItem {
  id             String    @id @default(uuid())
  priceListId    String
  skuId          String
  price          Decimal   @db.Decimal(20, 2)
  compareAtPrice Decimal?  @db.Decimal(20, 2)
  tenantId       String
  priceList      PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  sku            Sku       @relation(fields: [skuId], references: [id], onDelete: Cascade)
  tenant         Tenant    @relation(fields: [tenantId], references: [id])

  @@unique([priceListId, skuId])
  @@index([skuId])
  @@index([tenantId])
}

model Role {
  id          String           @id @default(uuid())
  name        String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  tenantId    String
  description String?
  tenant      Tenant           @relation(fields: [tenantId], references: [id])
  permissions RolePermission[]
  users       UserRole[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Permission {
  id        String           @id @default(uuid())
  name      String           @unique
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  roles     RolePermission[]
  users     UserPermission[]
}

model UserRole {
  userId String
  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([roleId])
}

model RolePermission {
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

model UserPermission {
  userId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, permissionId])
  @@index([permissionId])
}

model Category {
  id              String              @id @default(uuid())
  name            String
  slug            String
  parentId        String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  imageUrl        String?
  metaDescription String?
  metaKeywords    String?
  metaTitle       String?
  deletedAt       DateTime?
  tenantId        String
  imageId         String?
  image           Media?              @relation(fields: [imageId], references: [id])
  parent          Category?           @relation("CategoryToCategory", fields: [parentId], references: [id])
  children        Category[]          @relation("CategoryToCategory")
  tenant          Tenant              @relation(fields: [tenantId], references: [id])
  products        ProductToCategory[]

  @@unique([tenantId, slug])
  @@unique([tenantId, name])
  @@unique([id, tenantId])
  @@index([parentId])
  @@index([tenantId])
  @@index([tenantId, parentId])
  @@index([tenantId, createdAt(sort: Desc)])
}

model Brand {
  id        String    @id @default(uuid())
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  imageUrl  String?
  deletedAt DateTime?
  tenantId  String
  imageId   String?
  slug      String
  image     Media?    @relation(fields: [imageId], references: [id])
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  products  Product[]

  @@unique([tenantId, name])
  @@unique([tenantId, slug])
  @@unique([id, tenantId])
  @@index([tenantId])
  @@index([tenantId, createdAt(sort: Desc)])
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Product {
  id              String               @id @default(uuid())
  name            String               @db.VarChar(255)
  slug            String               @db.VarChar(255)
  description     String?
  brandId         String
  metadata        Json?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  deletedAt       DateTime?
  metaDescription String?
  metaKeywords    String?
  metaTitle       String?
  maxPrice        Decimal?             @db.Decimal(20, 2)
  minPrice        Decimal?             @db.Decimal(20, 2)
  avgRating       Float?               @default(0)
  reviewCount     Int                  @default(0)
  tenantId        String
  commissionRate  Decimal              @default(0) @db.Decimal(5, 2)
  products        BlogProduct[]
  brand           Brand                @relation(fields: [brandId], references: [id])
  tenant          Tenant               @relation(fields: [tenantId], references: [id])
  images          ProductImage[]
  options         ProductOption[]
  categories      ProductToCategory[]
  translations    ProductTranslation[]
  reviews         Review[]
  skus            Sku[]
  wishlists       Wishlist[]

  @@unique([tenantId, slug])
  @@unique([id, tenantId])
  @@index([brandId, minPrice, maxPrice, createdAt(sort: Desc)], map: "idx_product_brand_price")
  @@index([minPrice, maxPrice, createdAt(sort: Desc)], map: "idx_product_price_range")
  @@index([brandId, createdAt(sort: Desc)], map: "idx_product_brand_created")
  @@index([minPrice, createdAt(sort: Desc)], map: "idx_product_price_asc")
  @@index([maxPrice(sort: Desc), createdAt(sort: Desc)], map: "idx_product_price_desc")
  @@index([deletedAt, createdAt(sort: Desc)], map: "idx_product_active")
  @@index([avgRating(sort: Desc), reviewCount(sort: Desc)], map: "idx_product_rating")
  @@index([name])
  @@index([description])
  @@index([metadata], type: Gin)
  @@index([slug])
  @@index([tenantId])
  @@index([tenantId, deletedAt])
  @@index([tenantId, brandId, deletedAt])
  @@index([tenantId, minPrice, maxPrice, deletedAt])
  @@index([tenantId, deletedAt, createdAt])
}

model ProductToCategory {
  productId  String
  categoryId String
  tenantId   String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  tenant     Tenant   @relation(fields: [tenantId], references: [id])

  @@id([productId, categoryId])
  @@index([categoryId])
  @@index([productId])
  @@index([tenantId])
}

model ProductOption {
  id           String        @id @default(uuid())
  name         String        @db.VarChar(50)
  displayOrder Int?
  productId    String
  tenantId     String
  values       OptionValue[]
  product      Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  tenant       Tenant        @relation(fields: [tenantId], references: [id])

  @@index([productId])
  @@index([tenantId])
}

model OptionValue {
  id          String             @id @default(uuid())
  value       String             @db.VarChar(50)
  imageUrl    String?
  optionId    String
  imageId     String?
  tenantId    String
  image       Media?             @relation(fields: [imageId], references: [id])
  option      ProductOption      @relation(fields: [optionId], references: [id], onDelete: Cascade)
  tenant      Tenant             @relation(fields: [tenantId], references: [id])
  skuVariants SkuToOptionValue[]

  @@index([optionId])
  @@index([tenantId])
}

model Sku {
  id                 String              @id @default(uuid())
  skuCode            String              @db.VarChar(50)
  productId          String
  price              Decimal?            @db.Decimal(20, 2)
  salePrice          Decimal?            @db.Decimal(20, 2)
  stock              Int                 @default(0)
  imageUrl           String?
  status             String              @default("INACTIVE")
  metadata           Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  reservedStock      Int                 @default(0)
  tenantId           String
  cartItems          CartItem[]
  inventoryItems     InventoryItem[]
  inventoryLogs      InventoryLog[]
  orderItems         OrderItem[]
  priceListItems     PriceListItem[]
  purchaseOrderItems PurchaseOrderItem[]
  reviews            Review[]
  product            Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  tenant             Tenant              @relation(fields: [tenantId], references: [id])
  images             SkuImage[]
  optionValues       SkuToOptionValue[]

  @@unique([tenantId, skuCode])
  @@unique([id, tenantId])
  @@index([productId])
  @@index([skuCode])
  @@index([tenantId])
  @@index([metadata], type: Gin)
  @@index([tenantId, productId, status])
}

model Warehouse {
  id             String          @id @default(uuid())
  name           String
  address        String?
  isDefault      Boolean         @default(false)
  tenantId       String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  inventoryItems InventoryItem[]
  tenant         Tenant          @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model InventoryItem {
  id            String    @id @default(uuid())
  warehouseId   String
  skuId         String
  quantity      Int       @default(0)
  minStockLevel Int       @default(0)
  tenantId      String
  sku           Sku       @relation(fields: [skuId], references: [id], onDelete: Cascade)
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  warehouse     Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, skuId])
  @@index([skuId])
  @@index([tenantId])
}

model SkuToOptionValue {
  skuId         String
  optionValueId String
  tenantId      String
  optionValue   OptionValue @relation(fields: [optionValueId], references: [id], onDelete: Cascade)
  sku           Sku         @relation(fields: [skuId], references: [id], onDelete: Cascade)
  tenant        Tenant      @relation(fields: [tenantId], references: [id])

  @@id([skuId, optionValueId])
  @@index([tenantId])
}

model Address {
  id            String   @id @default(uuid())
  userId        String
  isDefault     Boolean  @default(false)
  recipientName String
  phoneNumber   String
  street        String
  city          String
  district      String
  ward          String?
  postalCode    String?
  country       String?  @db.VarChar(100)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  districtId    Int?
  provinceId    Int?
  wardCode      String?
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders        Order[]

  @@index([userId])
  @@index([tenantId])
}

model Cart {
  id        String     @id @default(uuid())
  userId    String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  tenantId  String
  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  @@unique([userId, tenantId])
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String
  skuId     String
  quantity  Int      @default(1)
  version   Int      @default(0) // [RACE CONDITION FIX C5] Optimistic locking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenantId  String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  sku       Sku      @relation(fields: [skuId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([cartId, skuId])
  @@index([skuId])
  @@index([tenantId])
  @@index([tenantId, cartId])
  @@index([tenantId, skuId])
}

model Promotion {
  id          String            @id @default(uuid())
  name        String
  code        String?
  description String?
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean           @default(true)
  priority    Int               @default(0)
  usageLimit  Int?
  usedCount   Int               @default(0)
  tenantId    String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  tenant      Tenant            @relation(fields: [tenantId], references: [id])
  actions     PromotionAction[]
  rules       PromotionRule[]
  usages      PromotionUsage[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
  @@index([startDate, endDate])
}

model PromotionRule {
  id          String    @id @default(uuid())
  promotionId String
  type        String
  operator    String
  value       String
  tenantId    String
  promotion   Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  tenant      Tenant    @relation(fields: [tenantId], references: [id])

  @@index([promotionId])
  @@index([tenantId])
}

model PromotionAction {
  id                String    @id @default(uuid())
  promotionId       String
  type              String
  value             String
  maxDiscountAmount Decimal?  @db.Decimal(20, 2)
  tenantId          String
  promotion         Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  tenant            Tenant    @relation(fields: [tenantId], references: [id])

  @@index([promotionId])
  @@index([tenantId])
}

model PromotionUsage {
  id             String    @id @default(uuid())
  promotionId    String
  userId         String
  orderId        String
  discountAmount Decimal   @db.Decimal(20, 2)
  createdAt      DateTime  @default(now())
  tenantId       String
  order          Order     @relation(fields: [orderId], references: [id])
  promotion      Promotion @relation(fields: [promotionId], references: [id])
  tenant         Tenant    @relation(fields: [tenantId], references: [id])
  user           User      @relation(fields: [userId], references: [id])

  @@index([promotionId])
  @@index([userId])
  @@index([orderId])
  @@index([tenantId])
}

model Order {
  id                        String                  @id @default(uuid())
  userId                    String
  status                    OrderStatus             @default(PENDING)
  totalAmount               Decimal                 @db.Decimal(20, 2)
  shippingFee               Decimal                 @default(0.00) @db.Decimal(20, 2)
  recipientName             String
  phoneNumber               String
  shippingAddress           String?
  paymentMethod             String?
  paymentStatus             PaymentStatus           @default(UNPAID)
  transactionId             String?
  orderDate                 DateTime                @default(now())
  updatedAt                 DateTime                @updatedAt
  createdAt                 DateTime                @default(now())
  addressId                 String?
  shippingCode              String?
  cancellationReason        String?
  expectedDeliveryTime      DateTime?
  ghnStatus                 String?
  tenantId                  String
  deletedAt                 DateTime?
  shippingAddressSnapshot   Json?
  shippingCity              String?
  shippingDistrict          String?
  shippingPhone             String?
  shippingWard              String?
  affiliateCommissionAmount Decimal?                @db.Decimal(20, 2)
  platformFeeAmount         Decimal?                @db.Decimal(20, 2)
  referredByBlogId          String?
  vatCompanyAddress         String?
  vatCompanyName            String?
  vatTaxId                  String?
  commissionTransactions    CommissionTransaction[]
  loyaltyPoints             LoyaltyPoint[]
  address                   Address?                @relation(fields: [addressId], references: [id])
  referredByBlog            Blog?                   @relation("BlogReferrals", fields: [referredByBlogId], references: [id])
  tenant                    Tenant                  @relation(fields: [tenantId], references: [id])
  user                      User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  items                     OrderItem[]
  taxDetails                OrderTaxDetail[]
  payments                  Payment[]
  promotions                PromotionUsage[]
  returnRequests            ReturnRequest[]
  shipments                 Shipment[]
  webhookEvents             WebhookEvent[]

  @@unique([id, tenantId])
  @@index([userId, createdAt(sort: Desc)], map: "idx_order_user_history")
  @@index([userId, status, createdAt(sort: Desc)], map: "idx_order_user_status")
  @@index([status, createdAt(sort: Desc)], map: "idx_order_status_date")
  @@index([paymentStatus, createdAt], map: "idx_order_payment_created")
  @@index([shippingCode], map: "idx_order_shipping_code")
  @@index([tenantId])
  @@index([tenantId, status, createdAt])
}

model Shipment {
  id           String         @id @default(uuid())
  orderId      String
  status       ShipmentStatus @default(PENDING)
  carrier      String?
  trackingCode String?
  shippedAt    DateTime?
  deliveredAt  DateTime?
  tenantId     String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  order        Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  tenant       Tenant         @relation(fields: [tenantId], references: [id])
  items        ShipmentItem[]

  @@index([orderId])
  @@index([tenantId])
}

model TaxRate {
  id        String   @id @default(uuid())
  name      String
  rate      Decimal  @db.Decimal(5, 2)
  isActive  Boolean  @default(true)
  tenantId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model OrderTaxDetail {
  id       String  @id @default(uuid())
  orderId  String
  name     String
  rate     Decimal @db.Decimal(5, 2)
  amount   Decimal @db.Decimal(20, 2)
  tenantId String
  order    Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  tenant   Tenant  @relation(fields: [tenantId], references: [id])

  @@index([orderId])
  @@index([tenantId])
}

model LoyaltyPoint {
  id        String           @id @default(uuid())
  userId    String
  orderId   String?
  amount    Int
  type      LoyaltyPointType @default(EARNED)
  reason    String?
  expiresAt DateTime?
  tenantId  String
  createdAt DateTime         @default(now())
  order     Order?           @relation(fields: [orderId], references: [id])
  tenant    Tenant           @relation(fields: [tenantId], references: [id])
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
  @@index([expiresAt])
}

model ShipmentItem {
  id          String    @id @default(uuid())
  shipmentId  String
  orderItemId String
  quantity    Int
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id])
  shipment    Shipment  @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId])
  @@index([orderItemId])
}

model ReturnRequest {
  id              String       @id @default(uuid())
  orderId         String
  userId          String
  status          ReturnStatus @default(PENDING)
  reason          String
  description     String?
  refundAmount    Decimal?     @db.Decimal(20, 2)
  images          String[]
  tenantId        String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  bankAccount     Json?
  carrier         String?
  inspectionNotes String?
  pickupAddress   Json?
  refundMethod    RefundMethod @default(ORIGINAL_PAYMENT)
  rejectedReason  String?
  returnMethod    ReturnMethod @default(SELF_SHIP)
  trackingCode    String?
  type            ReturnType   @default(RETURN_AND_REFUND)
  items           ReturnItem[]
  order           Order        @relation(fields: [orderId], references: [id])
  tenant          Tenant       @relation(fields: [tenantId], references: [id])
  user            User         @relation(fields: [userId], references: [id])

  @@index([orderId])
  @@index([userId])
  @@index([tenantId])
  @@index([status])
}

model ReturnItem {
  id              String        @id @default(uuid())
  returnRequestId String
  orderItemId     String
  quantity        Int
  orderItem       OrderItem     @relation(fields: [orderItemId], references: [id])
  returnRequest   ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)

  @@index([returnRequestId])
}

model OrderItem {
  id              String         @id @default(uuid())
  orderId         String
  skuId           String
  quantity        Int
  priceAtPurchase Decimal        @db.Decimal(20, 2)
  imageUrl        String?        // Original URL (may break if deleted)
  imageSnapshotUrl String?       // [DATA INTEGRITY FIX C4] Permanent snapshot URL
  productName     String?
  productSlug     String?
  skuNameSnapshot String?
  tenantId        String
  order           Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sku             Sku            @relation(fields: [skuId], references: [id])
  tenant          Tenant         @relation(fields: [tenantId], references: [id])
  returnItems     ReturnItem[]
  shipmentItems   ShipmentItem[]

  @@unique([orderId, skuId])
  @@index([skuId])
  @@index([tenantId])
  @@index([tenantId, orderId])
  @@index([tenantId, skuId])
}

model Review {
  id         String     @id @default(uuid())
  userId     String
  productId  String
  rating     Int        @db.SmallInt
  content    String?
  isApproved Boolean    @default(false)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  skuId      String?
  images     String[]
  reply      String?
  replyAt    DateTime?
  tenantId   String
  deletedAt  DateTime?
  autoTags   String[]
  sentiment  Sentiment?
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku        Sku?       @relation(fields: [skuId], references: [id])
  tenant     Tenant     @relation(fields: [tenantId], references: [id])
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId, skuId])
  @@index([productId, rating])
  @@index([skuId])
  @@index([tenantId])
  @@index([tenantId, productId, isApproved, createdAt(sort: Desc)])
  @@index([sentiment])
}

model AuditLog {
  id        String   @default(uuid())
  userId    String?
  action    String
  resource  String
  payload   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@id([id, createdAt])
  @@index([userId])
  @@index([resource])
  @@index([action])
  @@index([payload], type: Gin)
}

model ProductTranslation {
  id          String  @id @default(uuid())
  productId   String
  locale      String
  name        String  @db.VarChar(255)
  description String?
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale])
  @@index([productId])
  @@index([locale])
}

model ProductImage {
  id           String  @id @default(uuid())
  url          String
  alt          String?
  displayOrder Int     @default(0)
  productId    String
  mediaId      String?
  tenantId     String
  media        Media?  @relation(fields: [mediaId], references: [id])
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tenant       Tenant  @relation(fields: [tenantId], references: [id])

  @@index([productId])
  @@index([tenantId])
}

model SkuImage {
  id           String  @id @default(uuid())
  url          String
  alt          String?
  displayOrder Int     @default(0)
  skuId        String
  mediaId      String?
  tenantId     String
  media        Media?  @relation(fields: [mediaId], references: [id])
  sku          Sku     @relation(fields: [skuId], references: [id], onDelete: Cascade)
  tenant       Tenant  @relation(fields: [tenantId], references: [id])

  @@index([skuId])
  @@index([tenantId])
}

model Notification {
  id        String   @id @default(uuid())
  type      String
  title     String
  message   String
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())
  userId    String
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
  @@index([isRead])
  @@index([tenantId, userId, isRead])
}

model InventoryLog {
  id            String           @id @default(uuid())
  skuId         String
  changeAmount  Int
  previousStock Int
  newStock      Int
  actionType    InventoryLogType @default(ADJUSTMENT)
  reason        String
  metadata      Json?
  userId        String?
  createdAt     DateTime         @default(now())
  tenantId      String
  sku           Sku              @relation(fields: [skuId], references: [id], onDelete: Cascade)
  tenant        Tenant           @relation(fields: [tenantId], references: [id])
  user          User?            @relation(fields: [userId], references: [id])

  @@index([skuId])
  @@index([userId])
  @@index([tenantId])
  @@index([skuId, createdAt(sort: Desc)])
  @@index([actionType])
}

model Wishlist {
  id        String   @id @default(uuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  tenantId  String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([tenantId])
  @@index([tenantId, userId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
}

model Blog {
  id             String        @id @default(uuid())
  title          String        @db.VarChar(255)
  slug           String        @db.VarChar(255)
  excerpt        String
  content        String
  image          String?       @db.VarChar(500)
  category       String        @db.VarChar(100)
  author         String        @db.VarChar(100)
  language       String        @default("en") @db.VarChar(5)
  readTime       String?       @db.VarChar(20)
  publishedAt    DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?
  userId         String?
  tenantId       String
  imageId        String?
  blogMedia      Media?        @relation(fields: [imageId], references: [id])
  tenant         Tenant        @relation(fields: [tenantId], references: [id])
  user           User?         @relation(fields: [userId], references: [id])
  products       BlogProduct[]
  referredOrders Order[]       @relation("BlogReferrals")

  @@unique([tenantId, slug])
  @@index([slug])
  @@index([tenantId])
  @@index([tenantId, category])
  @@index([tenantId, publishedAt(sort: Desc)])
  @@index([category])
  @@index([language])
  @@index([publishedAt])
  @@index([userId])
  @@index([deletedAt])
}

model BlogProduct {
  blogId    String
  productId String
  createdAt DateTime @default(now())
  blog      Blog     @relation(fields: [blogId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([blogId, productId])
  @@index([blogId])
  @@index([productId])
}

model FeatureFlag {
  id          String   @id @default(uuid())
  key         String   @unique
  description String?
  isEnabled   Boolean  @default(false)
  rules       Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  @@index([key])
  @@index([tenantId])
}

// =====================================================================
// WEBHOOK EVENT TRACKING - Idempotency & Replay Protection
// =====================================================================
model WebhookEvent {
  id             String   @id @default(uuid())
  webhookId      String   @unique // Payment gateway's transaction/request ID
  orderId        String
  provider       String   // "VNPAY" | "MOMO" | "STRIPE"
  payloadHash    String?  // SHA256 hash of payload for duplicate detection
  status         String   // "PROCESSED" | "FAILED" | "IGNORED"
  responseCode   String?  // Payment gateway response code
  processedAt    DateTime @default(now())
  attemptCount   Int      @default(1)
  lastAttemptAt  DateTime @default(now())
  tenantId       String
  
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([webhookId, orderId])
  @@index([orderId, provider])
  @@index([tenantId, processedAt(sort: Desc)])
  @@index([payloadHash])
}

model Payment {
  id                    String        @id @default(uuid())
  orderId               String
  amount                Decimal       @db.Decimal(20, 2)
  currency              String        @default("VND")
  status                PaymentStatus @default(PENDING)
  paymentMethod         String
  providerTransactionId String?
  metadata              Json?
  paidAt                DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  tenantId              String
  order                 Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  tenant                Tenant        @relation(fields: [tenantId], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([tenantId])
}

model NewsletterSubscriber {
  id        String   @id @default(uuid())
  email     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, email])
  @@index([email])
  @@index([tenantId])
}

model ChatConversation {
  id        String        @id @default(uuid())
  userId    String        @unique
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  user      User          @relation(fields: [userId], references: [id])
  messages  ChatMessage[]

  @@index([userId])
  @@index([updatedAt])
}

model ChatMessage {
  id             String           @id @default(uuid())
  conversationId String
  senderId       String
  senderType     SenderType       @default(USER)
  content        String
  isRead         Boolean          @default(false)
  sentAt         DateTime         @default(now())
  metadata       Json?
  type           MessageType      @default(TEXT)
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([sentAt])
}

model PerformanceMetric {
  id             String   @default(uuid())
  name           String
  value          Float
  rating         String
  url            String
  userAgent      String?
  navigationType String?
  createdAt      DateTime @default(now())

  @@id([id, createdAt])
  @@index([name])
  @@index([createdAt])
}

model AiChatSession {
  id        String          @id @default(uuid())
  userId    String?
  guestId   String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  messages  AiChatMessage[]
  user      User?           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([guestId])
  @@index([createdAt])
}

model AiChatMessage {
  id        String        @id @default(uuid())
  sessionId String
  role      AiChatRole
  content   String
  metadata  Json?
  createdAt DateTime      @default(now())
  session   AiChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
}

model OutboxEvent {
  id            String       @id @default(uuid())
  aggregateType String
  aggregateId   String
  type          String
  payload       Json
  createdAt     DateTime     @default(now())
  processedAt   DateTime?
  status        OutboxStatus @default(PENDING)
  error         String?

  @@index([status, createdAt])
}

model Tenant {
  id                    String                 @id @default(uuid())
  name                  String
  domain                String                 @unique
  themeConfig           Json?
  plan                  TenantPlan             @default(BASIC)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  address               String?
  contactEmail          String?
  contactPhone          String?
  currency              String                 @default("VND")
  customDomain          String?                @unique
  faviconUrl            String?
  isActive              Boolean                @default(true)
  locale                String                 @default("vi-VN")
  logoUrl               String?
  subdomain             String?                @unique
  suspendedAt           DateTime?
  suspensionReason      String?
  timezone              String                 @default("Asia/Ho_Chi_Minh")
  dbUrl                 String?
  ownerId               String?
  deletedAt             DateTime?
  businessSize          String?
  businessType          String?
  currentProductCount   Int                    @default(0)
  currentStaffCount     Int                    @default(0)
  currentStorageUsed    Int                    @default(0)
  monthlyRevenue        String?
  onboardingCompleted   Boolean                @default(false)
  onboardingStep        Int                    @default(0)
  productLimit          Int                    @default(100)
  referralCode          String?                @unique
  referredByCode        String?
  staffLimit            Int                    @default(2)
  storageLimit          Int                    @default(1024)
  trialEndsAt           DateTime?
  trialStartedAt        DateTime?
  allowSocialRegistration Boolean @default(true)
  addresses             Address[]
  blogs                 Blog[]
  brands                Brand[]
  carts                 Cart[]
  cartItems             CartItem[]
  categories            Category[]
  customerGroups        CustomerGroup[]
  featureFlags          FeatureFlag[]
  inventoryItems        InventoryItem[]
  inventoryLogs         InventoryLog[]
  invoices              Invoice[]
  loyaltyPoints         LoyaltyPoint[]
  media                 Media[]
  newsletterSubscribers NewsletterSubscriber[]
  notifications         Notification[]
  optionValues          OptionValue[]
  orders                Order[]
  orderItems            OrderItem[]
  orderTaxDetails       OrderTaxDetail[]
  pages                 Page[]
  payments              Payment[]
  priceLists            PriceList[]
  priceListItems        PriceListItem[]
  products              Product[]
  productImages         ProductImage[]
  productOptions        ProductOption[]
  productToCategories   ProductToCategory[]
  promotions            Promotion[]
  promotionActions      PromotionAction[]
  promotionRules        PromotionRule[]
  promotionUsages       PromotionUsage[]
  purchaseOrders        PurchaseOrder[]
  returnRequests        ReturnRequest[]
  reviews               Review[]
  roles                 Role[]
  shipments             Shipment[]
  skus                  Sku[]
  skuImages             SkuImage[]
  skuToOptionValues     SkuToOptionValue[]
  metrics               StoreMetrics[]
  subscription          Subscription?
  suppliers             Supplier[]
  taxRates              TaxRate[]
  owner                 User?                  @relation("TenantOwner", fields: [ownerId], references: [id])
  settings              TenantSettings?
  translations          Translation[]
  users                 User[]
  warehouses            Warehouse[]
  webhookEvents         WebhookEvent[]
  wishlists             Wishlist[]

  @@index([deletedAt])
}

model TenantSettings {
  id                    String   @id @default(uuid())
  tenantId              String   @unique
  loyaltyPointRatio     Decimal  @default(1000)
  isLoyaltyEnabled      Boolean  @default(true)
  defaultShippingFee    Decimal  @default(30000)
  freeShippingThreshold Decimal?
  lowStockThreshold     Int      @default(5)
  updatedAt             DateTime @updatedAt
  tenant                Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model Supplier {
  id             String          @id @default(uuid())
  name           String
  email          String?
  phone          String?
  address        String?
  notes          String?
  tenantId       String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  deletedAt      DateTime?
  purchaseOrders PurchaseOrder[]
  tenant         Tenant          @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model PurchaseOrder {
  id          String              @id @default(uuid())
  supplierId  String
  tenantId    String
  status      PurchaseOrderStatus @default(PENDING)
  notes       String?
  totalAmount Decimal             @default(0) @db.Decimal(20, 2)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  supplier    Supplier            @relation(fields: [supplierId], references: [id])
  tenant      Tenant              @relation(fields: [tenantId], references: [id])
  items       PurchaseOrderItem[]

  @@index([supplierId])
  @@index([tenantId])
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  skuId           String
  quantity        Int
  costPrice       Decimal       @db.Decimal(20, 2)
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  sku             Sku           @relation(fields: [skuId], references: [id])

  @@index([purchaseOrderId])
  @@index([skuId])
}

model StoreMetrics {
  id             String   @id @default(uuid())
  tenantId       String
  date           DateTime @default(now())
  totalOrders    Int      @default(0)
  totalRevenue   Decimal  @default(0) @db.Decimal(20, 2)
  totalVisits    Int      @default(0)
  conversionRate Float    @default(0)
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, date])
  @@index([tenantId])
}

model Translation {
  id        String   @id @default(uuid())
  tenantId  String
  locale    String
  key       String
  value     String
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, locale, key])
  @@index([tenantId, locale])
}

model Page {
  id          String    @id @default(uuid())
  tenantId    String
  slug        String
  title       String
  isPublished Boolean   @default(true)
  blocks      Json      @default("[]")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, slug])
  @@index([tenantId])
}

model Subscription {
  id                String            @id @default(uuid())
  tenantId          String            @unique
  plan              TenantPlan
  billingFrequency  BillingFrequency  @default(MONTHLY)
  startDate         DateTime          @default(now())
  nextBillingDate   DateTime
  isActive          Boolean           @default(true)
  cancelAtPeriodEnd Boolean           @default(false)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  planId            String?
  invoices          Invoice[]
  subscriptionPlan  SubscriptionPlan? @relation(fields: [planId], references: [id])
  tenant            Tenant            @relation(fields: [tenantId], references: [id])
}

model Invoice {
  id             String        @id @default(uuid())
  tenantId       String
  subscriptionId String?
  amount         Decimal       @db.Decimal(10, 2)
  currency       String        @default("VND")
  status         InvoiceStatus @default(PENDING)
  description    String?
  paidAt         DateTime?
  dueDate        DateTime
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])
  tenant         Tenant        @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([status])
}

model SubscriptionPlan {
  id             String         @id @default(uuid())
  name           String
  slug           String         @unique
  description    String?
  priceMonthly   Decimal        @default(0) @db.Decimal(10, 2)
  priceYearly    Decimal        @default(0) @db.Decimal(10, 2)
  currency       String         @default("VND")
  maxProducts    Int            @default(100)
  maxStorage     Int            @default(1024)
  transactionFee Decimal        @default(0.0) @db.Decimal(5, 2)
  features       Json?          @default("[]")
  isActive       Boolean        @default(true)
  isPublic       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  badge          String?
  isPopular      Boolean        @default(false)
  maxStaff       Int            @default(2)
  maxWarehouses  Int            @default(1)
  sortOrder      Int            @default(0)
  trialDays      Int            @default(14)
  subscriptions  Subscription[]
}

model PlatformSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  description String?
  type        String   @default("string")
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CommissionTransaction {
  id        String           @id @default(uuid())
  userId    String
  orderId   String?
  amount    Decimal          @db.Decimal(20, 2)
  type      CommissionType
  status    CommissionStatus @default(COMPLETED)
  note      String?
  createdAt DateTime         @default(now())
  order     Order?           @relation(fields: [orderId], references: [id])
  user      User             @relation(fields: [userId], references: [id])
}

enum LoyaltyPointType {
  EARNED
  REDEEMED
  REFUNDED
}

enum ShipmentStatus {
  PENDING
  READY_TO_SHIP
  SHIPPED
  DELIVERED
  FAILED
  RETURNED
}

enum ReturnStatus {
  PENDING
  APPROVED
  RECEIVED
  REFUNDED
  REJECTED
  CANCELLED
  WAITING_FOR_RETURN
  IN_TRANSIT
  INSPECTING
}

enum ReturnType {
  REFUND_ONLY
  RETURN_AND_REFUND
  EXCHANGE
}

enum ReturnMethod {
  AT_COUNTER
  PICKUP
  SELF_SHIP
}

enum RefundMethod {
  ORIGINAL_PAYMENT
  BANK_TRANSFER
  WALLET
}

enum Sentiment {
  POSITIVE
  NEGATIVE
  NEUTRAL
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
  COMPLETED
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum SenderType {
  USER
  ADMIN
}

enum MessageType {
  TEXT
  IMAGE
  PRODUCT
  ORDER
}

enum AiChatRole {
  USER
  ASSISTANT
}

enum OutboxStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PurchaseOrderStatus {
  PENDING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum TenantPlan {
  BASIC
  PRO
  ENTERPRISE
}

enum BillingFrequency {
  MONTHLY
  YEARLY
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  VOID
}

enum CommissionType {
  DIRECT_REFERRAL
  SUBSCRIPTION_FEE
  TIER_2_REFERRAL
  WITHDRAWAL
}

enum CommissionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum InventoryLogType {
  ADJUSTMENT
  SALE
  TRANSFER_IN
  TRANSFER_OUT
  RETURN
  PURCHASE
  STOCKTAKE
}
