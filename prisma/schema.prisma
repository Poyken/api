generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// üìö GI·∫¢I TH√çCH CHO TH·ª∞C T·∫¨P SINH:
// File n√†y ƒë·ªãnh nghƒ©a c·∫•u tr√∫c c∆° s·ªü d·ªØ li·ªáu (Database Schema) c·ªßa h·ªá th·ªëng.
// Ch√∫ng ta s·ª≠ d·ª•ng Prisma ORM ƒë·ªÉ qu·∫£n l√Ω Database.
// C√°c quy t·∫Øc chung:
// 1. M·ªói b·∫£ng (model) ƒë·ªÅu c√≥ tenantId ƒë·ªÉ h·ªó tr·ª£ ƒëa c·ª≠a h√†ng (Multi-tenancy).
// 2. S·ª≠ d·ª•ng UUID cho ID ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh duy nh·∫•t v√† b·∫£o m·∫≠t.
// 3. C√≥ ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng createdAt, updatedAt v√† deletedAt (cho x√≥a m·ªÅm).
// 4. C√°c quan h·ªá (relation) ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a r√µ r√†ng ƒë·ªÉ ƒë·∫£m b·∫£o to√†n v·∫πn d·ªØ li·ªáu.

model User {
  id                     String                  @id @default(uuid()) // ID ƒë·ªãnh danh duy nh·∫•t c·ªßa User, t·ª± ƒë·ªông t·∫°o UUID
  email                  String // ƒê·ªãa ch·ªâ email d√πng ƒë·ªÉ ƒëƒÉng nh·∫≠p v√† li√™n h·ªá
  firstName              String? // T√™n ng∆∞·ªùi d√πng (c√≥ th·ªÉ ƒë·ªÉ tr·ªëng)
  lastName               String? // H·ªç ng∆∞·ªùi d√πng (c√≥ th·ªÉ ƒë·ªÉ tr·ªëng)
  password               String?                 @db.VarChar(255) // M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c m√£ h√≥a (Hash), gi·ªõi h·∫°n 255 k√Ω t·ª±
  createdAt              DateTime                @default(now()) // Th·ªùi ƒëi·ªÉm t·∫°o t√†i kho·∫£n
  updatedAt              DateTime                @updatedAt // Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t th√¥ng tin g·∫ßn nh·∫•t
  deletedAt              DateTime? // Th·ªùi ƒëi·ªÉm x√≥a m·ªÅm (Soft delete). N·∫øu c√≥ gi√° tr·ªã nghƒ©a l√† t√†i kho·∫£n ƒë√£ b·ªã v√¥ hi·ªáu h√≥a
  avatarUrl              String? // ƒê∆∞·ªùng d·∫´n ·∫£nh ƒë·∫°i di·ªán (URL)
  provider               String? // Nh√† cung c·∫•p ƒëƒÉng nh·∫≠p (Google, Facebook) n·∫øu d√πng Social Login
  socialId               String? // ID ƒë·ªãnh danh t·ª´ m·∫°ng x√£ h·ªôi (VD: Google User ID)
  twoFactorEnabled       Boolean                 @default(false) // C·ªù b·∫≠t/t·∫Øt t√≠nh nƒÉng b·∫£o m·∫≠t 2 l·ªõp (2FA)
  twoFactorSecret        String? // M√£ b√≠ m·∫≠t d√πng ƒë·ªÉ t·∫°o OTP cho 2FA
  whitelistedIps         Json?                   @default("[]") // Danh s√°ch c√°c ƒë·ªãa ch·ªâ IP ƒë∆∞·ª£c ph√©p truy c·∫≠p (l·ªõp b·∫£o m·∫≠t th√™m)
  commissionBalance      Decimal                 @default(0) @db.Decimal(20, 2) // S·ªë d∆∞ hoa h·ªìng t√≠ch l≈©y (cho content creator/affiliate)
  referredByUserId       String?
  referredByUser         User?                   @relation("UserReferrals", fields: [referredByUserId], references: [id])
  referrals              User[]                  @relation("UserReferrals")
  commissionTransactions CommissionTransaction[]
  loyaltyPoints          LoyaltyPoint[]

  // Media Reference
  avatarId String?
  avatar   Media?  @relation(fields: [avatarId], references: [id])

  // C√°c m·ªëi quan h·ªá (Relations) v·ªõi c√°c b·∫£ng kh√°c
  addresses      Address[] // Danh s√°ch ƒë·ªãa ch·ªâ giao h√†ng c·ªßa user
  auditLogs      AuditLog[] // L·ªãch s·ª≠ ho·∫°t ƒë·ªông/truy v·∫øt c·ªßa user
  carts          Cart[] // Gi·ªè h√†ng (th∆∞·ªùng ch·ªâ 1 active, nh∆∞ng thi·∫øt k·∫ø m·∫£ng ƒë·ªÉ m·ªü r·ªông history)
  inventoryLogs  InventoryLog[] // Log kho h√†ng (n·∫øu user l√† nh√¢n vi√™n kho)
  notifications  Notification[] // C√°c th√¥ng b√°o g·ª≠i ƒë·∫øn user
  orders         Order[] // L·ªãch s·ª≠ ƒë∆°n h√†ng ƒë√£ mua
  reviews        Review[] // C√°c ƒë√°nh gi√° s·∫£n ph·∫©m ƒë√£ mua
  permissions    UserPermission[] // C√°c quy·ªÅn h·∫°n c·ª• th·ªÉ (Granular permissions)
  roles          UserRole[] // C√°c vai tr√≤ c·ªßa user (Admin, Staff, Customer...)
  wishlist       Wishlist[] // Danh s√°ch s·∫£n ph·∫©m y√™u th√≠ch
  blogs          Blog[] // B√†i vi·∫øt blog (n·∫øu user l√† content writer)
  conversations  ChatConversation[] // C√°c cu·ªôc h·ªôi tho·∫°i chat support
  aiChatSessions AiChatSession[] // L·ªãch s·ª≠ chat v·ªõi AI Bot
  ownedTenants   Tenant[]           @relation("TenantOwner")

  // Multi-tenancy (ƒêa c·ª≠a h√†ng)
  tenantId String // ID c·ªßa c·ª≠a h√†ng m√† User n√†y thu·ªôc v·ªÅ
  tenant   Tenant @relation(fields: [tenantId], references: [id]) // Quan h·ªá t·ªõi b·∫£ng Tenant

  // Customer Group
  customerGroupId String?
  customerGroup   CustomerGroup?   @relation(fields: [customerGroupId], references: [id])
  promotions      PromotionUsage[]
  returnRequests  ReturnRequest[]

  @@unique([tenantId, email]) // ƒê·∫£m b·∫£o email l√† duy nh·∫•t trong ph·∫°m vi m·ªôt c·ª≠a h√†ng
  @@unique([id, tenantId]) // Composite Key cho b·∫£o m·∫≠t m·ª©c Tenant
  // C√°c ch·ªâ m·ª•c (Indexes) ƒë·ªÉ t·ªëi ∆∞u truy v·∫•n
  @@index([email]) // T√¨m ki·∫øm nhanh theo email
  @@index([tenantId]) // L·ªçc nhanh user theo c·ª≠a h√†ng
  @@index([tenantId, createdAt(sort: Desc)]) // S·∫Øp x·∫øp user m·ªõi nh·∫•t trong t·ª´ng c·ª≠a h√†ng
  @@index([customerGroupId]) // Index cho kh√≥a ngo·∫°i CustomerGroup
}

// =====================================================================
// MEDIA MANAGEMENT
// =====================================================================

model Media {
  id        String    @id @default(uuid())
  url       String    @db.VarChar(2048) // URL c·ªßa file media
  type      String    @db.VarChar(50) // Lo·∫°i file (image, video, document)
  mimeType  String?   @db.VarChar(100) // MIME type (image/jpeg, video/mp4)
  fileName  String?   @db.VarChar(255) // T√™n file g·ªëc
  altText   String?   @db.VarChar(255) // VƒÉn b·∫£n thay th·∫ø cho SEO v√† tr·ª£ nƒÉng
  size      Int? // K√≠ch th∆∞·ªõc file theo byte
  width     Int? // Chi·ªÅu r·ªông (ƒë·ªëi v·ªõi ·∫£nh/video)
  height    Int? // Chi·ªÅu cao (ƒë·ªëi v·ªõi ·∫£nh/video)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Multi-tenancy
  tenantId String // ID c·ªßa Tenant s·ªü h·ªØu media n√†y
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Relations
  users         User[]
  categories    Category[]
  brands        Brand[]
  blogs         Blog[]
  productImages ProductImage[]
  skuImages     SkuImage[]
  optionValues  OptionValue[]

  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, createdAt(sort: Desc)])
}

model CustomerGroup {
  id          String  @id @default(uuid())
  name        String // VIP, Wholesale
  description String?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  users User[]

  // Price List (B2B)
  priceListId String?
  priceList   PriceList? @relation(fields: [priceListId], references: [id])

  createdAt DateTime @default(now()) // Ng√†y t·∫°o
  updatedAt DateTime @updatedAt // Ng√†y c·∫≠p nh·∫≠t

  @@unique([tenantId, name])
  @@index([priceListId]) // Index cho kh√≥a ngo·∫°i PriceList
}

// =====================================================================
// B2B - PRICE LISTS
// =====================================================================

model PriceList {
  id        String    @id @default(uuid())
  name      String // B·∫£ng gi√° ƒë·∫°i l√Ω, B·∫£ng gi√° b√°n l·∫ª
  currency  String    @default("VND")
  isDefault Boolean   @default(false)
  startDate DateTime?
  endDate   DateTime?
  isActive  Boolean   @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  items          PriceListItem[]
  customerGroups CustomerGroup[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model PriceListItem {
  id             String   @id @default(uuid())
  priceListId    String
  skuId          String
  price          Decimal  @db.Decimal(20, 2) // Gi√° √°p d·ª•ng
  compareAtPrice Decimal? @db.Decimal(20, 2) // Gi√° g·ªëc (ƒë·ªÉ g·∫°ch ngang)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  priceList PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  sku       Sku       @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@unique([priceListId, skuId])
  @@index([skuId]) // Index t·ªëi ∆∞u truy v·∫•n ng∆∞·ª£c t·ª´ SKU
  @@index([tenantId])
}

model Role {
  id          String           @id @default(uuid()) // ID ƒë·ªãnh danh duy nh·∫•t c·ªßa Role (Vai tr√≤)
  name        String // T√™n c·ªßa vai tr√≤ (VD: Admin, Staff, Viewer)
  createdAt   DateTime         @default(now()) // Th·ªùi gian t·∫°o
  updatedAt   DateTime         @updatedAt // Th·ªùi gian c·∫≠p nh·∫≠t
  permissions RolePermission[] // Danh s√°ch c√°c quy·ªÅn h·∫°n thu·ªôc vai tr√≤ n√†y
  users       UserRole[] // Danh s√°ch ng∆∞·ªùi d√πng c√≥ vai tr√≤ n√†y

  // Multi-tenancy
  tenantId String // ID c·ªßa Tenant (C·ª≠a h√†ng) s·ªü h·ªØu role n√†y
  tenant   Tenant @relation(fields: [tenantId], references: [id]) // Quan h·ªá t·ªõi model Tenant

  @@unique([tenantId, name]) // T√™n role ph·∫£i l√† duy nh·∫•t trong c√πng m·ªôt Tenant
  @@index([tenantId]) // Index ƒë·ªÉ l·ªçc nhanh c√°c role c·ªßa m·ªôt Tenant
}

model Permission {
  id        String           @id @default(uuid()) // ID c·ªßa Quy·ªÅn h·∫°n
  name      String           @unique // T√™n quy·ªÅn h·∫°n (Duy nh·∫•t to√†n h·ªá th·ªëng, VD: PRODUCT_CREATE)
  createdAt DateTime         @default(now()) // Th·ªùi gian t·∫°o
  updatedAt DateTime         @updatedAt // Th·ªùi gian c·∫≠p nh·∫≠t
  roles     RolePermission[] // Danh s√°ch c√°c Role c√≥ quy·ªÅn n√†y
  users     UserPermission[] // Danh s√°ch User ƒë∆∞·ª£c g√°n tr·ª±c ti·∫øp quy·ªÅn n√†y
}

model UserRole {
  userId String // ID c·ªßa User
  roleId String // ID c·ªßa Role
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade) // Link t·ªõi Role
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade) // Link t·ªõi User

  @@id([userId, roleId]) // Kh√≥a ch√≠nh k·∫øt h·ª£p (M·ªôt user ch·ªâ c√≥ 1 l·∫ßn role n√†y)
  @@index([roleId]) // Index ƒë·ªÉ t√¨m nhanh t·∫•t c·∫£ user c√≥ role n√†y
}

model RolePermission {
  roleId       String // ID Role
  permissionId String // ID Permission
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId]) // Kh√≥a ch√≠nh k·∫øt h·ª£p
  @@index([permissionId]) // Index t√¨m c√°c role c√≥ permission n√†y
}

model UserPermission {
  userId       String // ID User
  permissionId String // ID Permission
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade) // Link permission
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade) // Link user

  @@id([userId, permissionId]) // Kh√≥a ch√≠nh k·∫øt h·ª£p
  @@index([permissionId]) // Index t√¨m user c√≥ permission n√†y
}

model Category {
  id        String    @id @default(uuid()) // ID danh m·ª•c
  name      String // T√™n danh m·ª•c (VD: ƒêi·ªán tho·∫°i, Qu·∫ßn √°o)
  slug      String // ƒê∆∞·ªùng d·∫´n th√¢n thi·ªán SEO (VD: dien-thoai)
  parentId  String? // ID danh m·ª•c cha (n·∫øu l√† danh m·ª•c con)
  createdAt DateTime  @default(now()) // Th·ªùi gian t·∫°o
  updatedAt DateTime  @updatedAt // Th·ªùi gian c·∫≠p nh·∫≠t
  deletedAt DateTime? // Th·ªùi gian x√≥a m·ªÅm (Soft delete)
  imageUrl  String? // ·∫¢nh ƒë·∫°i di·ªán danh m·ª•c (Legacy)
  imageId   String? // Link t·ªõi Media
  image     Media?    @relation(fields: [imageId], references: [id])

  metaDescription String? // Th·∫ª meta description cho SEO
  metaKeywords    String? // Th·∫ª meta keywords cho SEO
  metaTitle       String? // Th·∫ª meta title cho SEO
  parent          Category?           @relation("CategoryToCategory", fields: [parentId], references: [id]) // Link t·ªõi danh m·ª•c cha
  children        Category[]          @relation("CategoryToCategory") // Danh s√°ch danh m·ª•c con
  products        ProductToCategory[] // Danh s√°ch s·∫£n ph·∫©m thu·ªôc danh m·ª•c n√†y

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, slug]) // Slug ph·∫£i duy nh·∫•t trong Tenant
  @@unique([tenantId, name]) // T√™n danh m·ª•c kh√¥ng tr√πng trong Tenant
  @@unique([id, tenantId]) // B·∫£o m·∫≠t ID theo Tenant
  @@index([parentId]) // Index t√¨m danh m·ª•c con theo cha
  @@index([tenantId]) // Index l·ªçc theo Tenant
  @@index([tenantId, parentId]) // Index l·ªçc danh m·ª•c g·ªëc/con c·ªßa Tenant
  @@index([tenantId, createdAt(sort: Desc)]) // S·∫Øp x·∫øp danh m·ª•c m·ªõi nh·∫•t
}

model Brand {
  id        String    @id @default(uuid()) // ID Th∆∞∆°ng hi·ªáu
  name      String // T√™n th∆∞∆°ng hi·ªáu (VD: Samsung, Apple)
  createdAt DateTime  @default(now()) // Th·ªùi gian t·∫°o
  updatedAt DateTime  @updatedAt // Th·ªùi gian c·∫≠p nh·∫≠t
  deletedAt DateTime? // X√≥a m·ªÅm
  imageUrl  String? // Logo th∆∞∆°ng hi·ªáu (Legacy)
  imageId   String?
  image     Media?    @relation(fields: [imageId], references: [id])

  products Product[] // Danh s√°ch s·∫£n ph·∫©m thu·ªôc th∆∞∆°ng hi·ªáu

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, name]) // T√™n th∆∞∆°ng hi·ªáu duy nh·∫•t/Tenant
  @@unique([id, tenantId]) // B·∫£o m·∫≠t ID
  @@index([tenantId]) // Index theo Tenant
  @@index([tenantId, createdAt(sort: Desc)]) // S·∫Øp x·∫øp
}

model Product {
  id              String              @id @default(uuid()) // ID s·∫£n ph·∫©m
  name            String              @db.VarChar(255) // T√™n s·∫£n ph·∫©m, gi·ªõi h·∫°n 255 k√Ω t·ª±
  slug            String              @db.VarChar(255) // Slug URL th√¢n thi·ªán
  description     String? // M√¥ t·∫£ chi ti·∫øt (HTML ho·∫∑c Markdown)
  brandId         String // ID c·ªßa th∆∞∆°ng hi·ªáu
  categories      ProductToCategory[] // C√°c danh m·ª•c ch·ª©a s·∫£n ph·∫©m n√†y
  metadata        Json? // D·ªØ li·ªáu m·ªü r·ªông (Custom attributes)
  createdAt       DateTime            @default(now()) // Ng√†y t·∫°o
  updatedAt       DateTime            @updatedAt // Ng√†y c·∫≠p nh·∫≠t
  deletedAt       DateTime? // Ng√†y x√≥a m·ªÅm (n·∫øu null l√† ƒëang active)
  metaDescription String? // SEO: M√¥ t·∫£ ng·∫Øn
  metaKeywords    String? // SEO: T·ª´ kh√≥a
  metaTitle       String? // SEO: Ti√™u ƒë·ªÅ trang
  maxPrice        Decimal?            @db.Decimal(20, 2) // Gi√° cao nh·∫•t (c·ªßa bi·∫øn th·ªÉ) - d√πng cho filter
  minPrice        Decimal?            @db.Decimal(20, 2) // Gi√° th·∫•p nh·∫•t (c·ªßa bi·∫øn th·ªÉ) - hi·ªÉn th·ªã "T·ª´ X ƒë"
  avgRating       Float?              @default(0) // ƒêi·ªÉm ƒë√°nh gi√° trung b√¨nh
  reviewCount     Int                 @default(0) // T·ªïng s·ªë l∆∞·ª£t ƒë√°nh gi√°
  commissionRate  Decimal             @default(0) @db.Decimal(5, 2) // T·ª∑ l·ªá hoa h·ªìng m·∫∑c ƒë·ªãnh cho s·∫£n ph·∫©m n√†y (%)

  // Vector Embedding (768 dimensions for Gemini text-embedding-004)
  // Requires pgvector extension. Enable if available.
  // embedding       Unsupported("vector(768)")? // D√πng cho t√¨m ki·∫øm AI (Semantic Search)

  products     BlogProduct[] // ƒê∆∞·ª£c nh·∫Øc t·ªõi trong b√†i Blog n√†o
  brand        Brand                @relation(fields: [brandId], references: [id]) // Link t·ªõi Brand
  images       ProductImage[] // Danh s√°ch ·∫£nh s·∫£n ph·∫©m
  options      ProductOption[] // C√°c t√πy ch·ªçn (M√†u, Size...)
  translations ProductTranslation[] // ƒêa ng√¥n ng·ªØ
  reviews      Review[] // C√°c review c·ªßa s·∫£n ph·∫©m
  skus         Sku[] // Danh s√°ch bi·∫øn th·ªÉ (SKU)
  wishlists    Wishlist[] // Ai ƒë√£ like s·∫£n ph·∫©m n√†y

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  // ============================================================
  // PERFORMANCE INDEXES (Production-ready)
  // ============================================================

  // 5. Slug Lookup (already unique, optimized by default)
  // No need for additional index

  @@unique([tenantId, slug])
  @@unique([id, tenantId])
  // 1. Brand + Price Range Filter
  // Covers: WHERE brandId = Y AND minPrice >= A AND maxPrice <= B
  @@index([brandId, minPrice, maxPrice, createdAt(sort: Desc)], name: "idx_product_brand_price")
  // 2. Price Range (25% of queries)
  // Covers: WHERE minPrice >= A ORDER BY createdAt DESC
  @@index([minPrice, maxPrice, createdAt(sort: Desc)], name: "idx_product_price_range")
  // 3. Brand Filter (15% of queries)
  // Covers: WHERE brandId = X ORDER BY createdAt DESC
  @@index([brandId, createdAt(sort: Desc)], name: "idx_product_brand_created")
  // 4. Price Sorting (10% of queries)
  // Covers: ORDER BY minPrice ASC/DESC
  @@index([minPrice, createdAt(sort: Desc)], name: "idx_product_price_asc")
  @@index([maxPrice(sort: Desc), createdAt(sort: Desc)], name: "idx_product_price_desc")
  // 6. Active Products Filter (80% of queries need this)
  // Partial index: WHERE deletedAt IS NULL
  @@index([deletedAt, createdAt(sort: Desc)], name: "idx_product_active")
  // 7. Rating Filter (for "top rated" queries)
  // Covers: WHERE avgRating >= 4 ORDER BY avgRating DESC
  @@index([avgRating(sort: Desc), reviewCount(sort: Desc)], name: "idx_product_rating")
  // 8. Search Optimization (B-tree indexing for common searches)
  @@index([name]) // T√¨m theo t√™n
  @@index([description]) // T√¨m trong m√¥ t·∫£ (Full-text search s·∫Ω t·ªët h∆°n)
  @@index([metadata], type: Gin) // T√¨m trong JSON metadata
  // Legacy indexes (keep for backward compatibility, will remove in next version)
  // No duplicate name index here
  @@index([slug])
  // @@index([deletedAt]) - REMOVED: Covered by @@index([tenantId, deletedAt])
  @@index([tenantId])
  @@index([tenantId, deletedAt])
  @@index([tenantId, brandId, deletedAt])
  @@index([tenantId, minPrice, maxPrice, deletedAt])
  @@index([tenantId, deletedAt, createdAt]) // For Storefront listings
}

model ProductToCategory {
  productId  String // ID S·∫£n ph·∫©m
  categoryId String // ID Danh m·ª•c

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId]) // Kh√≥a ch√≠nh k·∫øt h·ª£p
  @@index([categoryId]) // Index l·ªçc s·∫£n ph·∫©m theo danh m·ª•c
  @@index([productId]) // Index xem s·∫£n ph·∫©m thu·ªôc danh m·ª•c n√†o
  @@index([tenantId])
}

model ProductOption {
  id           String @id @default(uuid()) // ID t√πy ch·ªçn (VD: M√†u s·∫Øc)
  name         String @db.VarChar(50) // T√™n t√πy ch·ªçn
  displayOrder Int? // Th·ª© t·ª± hi·ªÉn th·ªã
  productId    String // ID s·∫£n ph·∫©m

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  values  OptionValue[] // Danh s√°ch c√°c gi√° tr·ªã (ƒê·ªè, Xanh...)
  product Product       @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId]) // Index theo s·∫£n ph·∫©m
  @@index([tenantId])
}

model OptionValue {
  id       String  @id @default(uuid()) // ID gi√° tr·ªã t√πy ch·ªçn
  value    String  @db.VarChar(50) // Gi√° tr·ªã (VD: ƒê·ªè)
  imageUrl String? // ·∫¢nh ƒë·∫°i di·ªán cho gi√° tr·ªã n√†y (Legacy)
  imageId  String?
  image    Media?  @relation(fields: [imageId], references: [id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  optionId    String // ID t√πy ch·ªçn
  option      ProductOption      @relation(fields: [optionId], references: [id], onDelete: Cascade)
  skuVariants SkuToOptionValue[] // C√°c SKU s·ª≠ d·ª•ng gi√° tr·ªã n√†y

  @@index([optionId]) // Index theo option
  @@index([tenantId])
}

model Sku {
  id                 String              @id @default(uuid()) // ID SKU (ƒê∆°n v·ªã l∆∞u kho)
  skuCode            String              @db.VarChar(50) // M√£ SKU qu·∫£n l√Ω (VD: IPHONE-13-RED-64)
  productId          String // ID s·∫£n ph·∫©m cha
  price              Decimal?            @db.Decimal(20, 2) // Gi√° b√°n th∆∞·ªùng
  salePrice          Decimal?            @db.Decimal(20, 2) // Gi√° khuy·∫øn m√£i
  stock              Int                 @default(0) // S·ªë l∆∞·ª£ng t·ªìn kho (Deprecated: Use InventoryItem)
  imageUrl           String? // ·∫¢nh ri√™ng c·ªßa SKU n√†y
  status             String              @default("INACTIVE") // Tr·∫°ng th√°i (ACTIVE, INACTIVE)
  metadata           Json? // D·ªØ li·ªáu th√™m
  createdAt          DateTime            @default(now()) // Ng√†y t·∫°o
  updatedAt          DateTime            @updatedAt // Ng√†y c·∫≠p nh·∫≠t
  reservedStock      Int                 @default(0) // T·ªìn kho ƒëang ƒë∆∞·ª£c gi·ªØ (trong ƒë∆°n h√†ng ch∆∞a thanh to√°n)
  cartItems          CartItem[] // C√°c gi·ªè h√†ng ƒëang ch·ª©a SKU n√†y
  inventoryLogs      InventoryLog[] // L·ªãch s·ª≠ bi·∫øn ƒë·ªông kho
  inventoryItems     InventoryItem[] // ƒêa kho h√†ng
  orderItems         OrderItem[] // C√°c ƒë∆°n h√†ng ƒë√£ mua SKU n√†y
  reviews            Review[] // Review c·ª• th·ªÉ cho SKU n√†y
  optionValues       SkuToOptionValue[] // C√°c gi√° tr·ªã t√πy ch·ªçn (M√†u ƒê·ªè, 64GB) t·∫°o n√™n SKU n√†y
  priceListItems     PriceListItem[]
  purchaseOrderItems PurchaseOrderItem[]
  images             SkuImage[] // ·∫¢nh chi ti·∫øt SKU
  product            Product             @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, skuCode]) // M√£ SKU duy nh·∫•t trong Tenant
  @@unique([id, tenantId]) // B·∫£o m·∫≠t ID
  @@index([productId]) // Index theo s·∫£n ph·∫©m cha
  @@index([skuCode]) // T√¨m theo m√£ SKU
  @@index([tenantId]) // L·ªçc theo Tenant
  @@index([metadata], type: Gin) // T√¨m trong metadata
  @@index([tenantId, productId, status]) // L·ªçc SKU active c·ªßa s·∫£n ph·∫©m
}

model Warehouse {
  id             String          @id @default(uuid())
  name           String // T√™n kho (Kho HCM, Kho HN)
  address        String? // ƒê·ªãa ch·ªâ kho
  isDefault      Boolean         @default(false) // L√† kho m·∫∑c ƒë·ªãnh?
  tenantId       String
  tenant         Tenant          @relation(fields: [tenantId], references: [id])
  inventoryItems InventoryItem[]

  createdAt DateTime @default(now()) // Ng√†y t·∫°o
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model InventoryItem {
  id            String @id @default(uuid())
  warehouseId   String
  skuId         String
  quantity      Int    @default(0)
  minStockLevel Int    @default(0) // Ng∆∞·ª°ng c·∫£nh b√°o t·ªìn kho th·∫•p

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  sku       Sku       @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, skuId])
  @@index([skuId])
  @@index([tenantId])
}

model SkuToOptionValue {
  skuId         String // ID SKU
  optionValueId String // ID Gi√° tr·ªã t√πy ch·ªçn

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  optionValue OptionValue @relation(fields: [optionValueId], references: [id], onDelete: Cascade)
  sku         Sku         @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@id([skuId, optionValueId]) // Kh√≥a ch√≠nh k·∫øt h·ª£p
  @@index([tenantId])
}

model Address {
  id            String   @id @default(uuid()) // ID ƒë·ªãa ch·ªâ
  userId        String // ID ng∆∞·ªùi d√πng s·ªü h·ªØu
  isDefault     Boolean  @default(false) // C√≥ ph·∫£i ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh kh√¥ng
  recipientName String // T√™n ng∆∞·ªùi nh·∫≠n
  phoneNumber   String // S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi nh·∫≠n
  street        String // ƒê·ªãa ch·ªâ chi ti·∫øt (S·ªë nh√†, ƒë∆∞·ªùng)
  city          String // T·ªânh/Th√†nh ph·ªë
  district      String // Qu·∫≠n/Huy·ªán
  ward          String? // Ph∆∞·ªùng/X√£
  postalCode    String? // M√£ b∆∞u ƒëi·ªán
  country       String?  @db.VarChar(100) // Qu·ªëc gia
  createdAt     DateTime @default(now()) // Ng√†y t·∫°o
  updatedAt     DateTime @updatedAt // Ng√†y c·∫≠p nh·∫≠t
  districtId    Int? // ID Qu·∫≠n/Huy·ªán (cho t√≠ch h·ª£p GHN/GHTK)
  provinceId    Int? // ID T·ªânh/Th√†nh (cho t√≠ch h·ª£p GHN/GHTK)
  wardCode      String? // M√£ Ph∆∞·ªùng/X√£ (cho t√≠ch h·ª£p GHN/GHTK)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  orders Order[] // C√°c ƒë∆°n h√†ng d√πng ƒë·ªãa ch·ªâ n√†y

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@index([userId]) // L·ªçc ƒë·ªãa ch·ªâ theo User
  @@index([tenantId]) // L·ªçc theo Tenant
}

model Cart {
  id        String     @id @default(uuid()) // ID Gi·ªè h√†ng
  userId    String // ID User s·ªü h·ªØu
  createdAt DateTime   @default(now()) // Ng√†y t·∫°o
  updatedAt DateTime   @updatedAt // Ng√†y c·∫≠p nh·∫≠t
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[] // Danh s√°ch s·∫£n ph·∫©m trong gi·ªè

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([userId, tenantId]) // M·ªói user ch·ªâ c√≥ 1 gi·ªè h√†ng trong 1 Tenant
}

model CartItem {
  id        String   @id @default(uuid()) // ID m·ª•c trong gi·ªè
  cartId    String // ID Gi·ªè h√†ng
  skuId     String // ID SKU s·∫£n ph·∫©m
  quantity  Int      @default(1) // S·ªë l∆∞·ª£ng mua
  createdAt DateTime @default(now()) // Ng√†y th√™m v√†o
  updatedAt DateTime @updatedAt // Ng√†y c·∫≠p nh·∫≠t

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  cart Cart @relation(fields: [cartId], references: [id], onDelete: Cascade)
  sku  Sku  @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@unique([cartId, skuId]) // Trong 1 gi·ªè, m·ªôt SKU ch·ªâ xu·∫•t hi·ªán 1 d√≤ng
  @@index([skuId]) // Tham chi·∫øu ng∆∞·ª£c
  @@index([tenantId])
}

// =====================================================================
// PROMOTION ENGINE (Advanced)
// =====================================================================

model Promotion {
  id          String  @id @default(uuid())
  name        String // T√™n ch∆∞∆°ng tr√¨nh
  code        String? // M√£ nh·∫≠p (n·∫øu c√≥)
  description String?

  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(true) // Tr·∫°ng th√°i k√≠ch ho·∫°t
  priority  Int      @default(0) // ƒê·ªô ∆∞u ti√™n (S·ªë c√†ng l·ªõn c√†ng ∆∞u ti√™n cao)

  usageLimit Int? // Gi·ªõi h·∫°n s·ªë l·∫ßn s·ª≠ d·ª•ng t·ªïng c·ªông
  usedCount  Int  @default(0) // S·ªë l·∫ßn ƒë√£ s·ª≠ d·ª•ng

  // Rules & Actions
  rules   PromotionRule[]
  actions PromotionAction[]
  usages  PromotionUsage[]

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  createdAt DateTime @default(now()) // Ng√†y t·∫°o
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
  @@index([startDate, endDate]) // Index cho t√¨m ki·∫øm theo kho·∫£ng th·ªùi gian
}

model PromotionRule {
  id          String @id @default(uuid())
  promotionId String
  type        String // Lo·∫°i ƒëi·ªÅu ki·ªán (MIN_ORDER_VALUE, SPECIFIC_CATEGORY, CUSTOMER_GROUP...)
  operator    String // To√°n t·ª≠ so s√°nh (GTE, EQ, IN...)
  value       String // Gi√° tr·ªã so s√°nh (VD: "500000", "cat_123", "vip_group")

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  promotion Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@index([promotionId]) // Index Foreign Key
  @@index([tenantId])
}

model PromotionAction {
  id                String   @id @default(uuid())
  promotionId       String
  type              String // Lo·∫°i h√†nh ƒë·ªông (DISCOUNT_FIXED, DISCOUNT_PERCENT, FREE_SHIPPING, GIFT...)
  value             String // Gi√° tr·ªã gi·∫£m (VD: "50000", "10")
  maxDiscountAmount Decimal? @db.Decimal(20, 2) // S·ªë ti·ªÅn gi·∫£m t·ªëi ƒëa (cho lo·∫°i %)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  promotion Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@index([promotionId]) // Index Foreign Key
  @@index([tenantId])
}

model PromotionUsage {
  id             String  @id @default(uuid())
  promotionId    String
  userId         String
  orderId        String // Link to Order
  discountAmount Decimal @db.Decimal(20, 2)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  promotion Promotion @relation(fields: [promotionId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
  order     Order     @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())

  @@index([promotionId])
  @@index([userId])
  @@index([orderId])
  @@index([tenantId])
}

model Order {
  id                        String                  @id @default(uuid()) // ID ƒê∆°n h√†ng
  userId                    String // ID Ng∆∞·ªùi mua
  status                    OrderStatus             @default(PENDING) // Tr·∫°ng th√°i ƒë∆°n h√†ng
  totalAmount               Decimal                 @db.Decimal(20, 2) // T·ªïng ti·ªÅn
  shippingFee               Decimal                 @default(0.00) @db.Decimal(20, 2) // Ph√≠ v·∫≠n chuy·ªÉn
  recipientName             String // T√™n ng∆∞·ªùi nh·∫≠n
  phoneNumber               String // SƒêT ng∆∞·ªùi nh·∫≠n
  shippingAddress           String? // ƒê·ªãa ch·ªâ giao h√†ng (Text)
  shippingCity              String? // Th√†nh ph·ªë
  shippingDistrict          String? // Qu·∫≠n/Huy·ªán
  shippingWard              String? // Ph∆∞·ªùng/X√£
  shippingPhone             String? // SƒêT giao h√†ng (n·∫øu kh√°c)
  shippingAddressSnapshot   Json? // Snapshot ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß l√∫c ƒë·∫∑t (tr√°nh user s·ª≠a address sau n√†y l√†m sai data ƒë∆°n c≈©)
  paymentMethod             String? // Ph∆∞∆°ng th·ª©c thanh to√°n (COD, MOMO...)
  paymentStatus             PaymentStatus           @default(UNPAID) // Tr·∫°ng th√°i thanh to√°n
  transactionId             String? // M√£ giao d·ªãch (Legacy)
  payments                  Payment[] // L·ªãch s·ª≠ thanh to√°n chi ti·∫øt
  orderDate                 DateTime                @default(now()) // Ng√†y ƒë·∫∑t h√†ng
  updatedAt                 DateTime                @updatedAt // Ng√†y c·∫≠p nh·∫≠t
  createdAt                 DateTime                @default(now()) // Ng√†y t·∫°o b·∫£n ghi
  deletedAt                 DateTime? // X√≥a m·ªÅm
  referredByBlogId          String? // ID b√†i vi·∫øt gi·ªõi thi·ªáu d·∫´n ƒë·∫øn ƒë∆°n h√†ng n√†y
  platformFeeAmount         Decimal?                @db.Decimal(20, 2) // S·ªë ti·ªÅn ph√≠ s√†n thu t·ª´ tenant cho ƒë∆°n n√†y
  affiliateCommissionAmount Decimal?                @db.Decimal(20, 2) // S·ªë ti·ªÅn hoa h·ªìng tr·∫£ cho ng∆∞·ªùi vi·∫øt blog
  commissionTransactions    CommissionTransaction[]
  shipments                 Shipment[]
  taxDetails                OrderTaxDetail[]

  // VAT & Red Invoice Support (H√≥a ƒë∆°n ƒë·ªè)
  vatCompanyName    String?
  vatCompanyAddress String?
  vatTaxId          String?

  promotions     PromotionUsage[]
  returnRequests ReturnRequest[]

  addressId            String? // ID ƒë·ªãa ch·ªâ ƒë√£ ch·ªçn
  shippingCode         String? // M√£ v·∫≠n ƒë∆°n
  ghnStatus            String? // Tr·∫°ng th√°i t·ª´ GHN/GHTK
  expectedDeliveryTime DateTime? // Th·ªùi gian giao h√†ng d·ª± ki·∫øn
  cancellationReason   String? // L√Ω do h·ªßy ƒë∆°n

  address Address?    @relation(fields: [addressId], references: [id])
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items   OrderItem[] // Danh s√°ch s·∫£n ph·∫©m trong ƒë∆°n

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  referredByBlog Blog? @relation("BlogReferrals", fields: [referredByBlogId], references: [id])

  // ============================================================
  // PERFORMANCE INDEXES (Production-ready)
  // ============================================================

  @@unique([id, tenantId])
  // 1. User Order History (50% of queries)
  // Covers: WHERE userId = X ORDER BY createdAt DESC
  @@index([userId, createdAt(sort: Desc)], name: "idx_order_user_history")
  // 2. User + Status Filter (30% of queries)
  // Covers: WHERE userId = X AND status IN ('PENDING', 'PROCESSING')
  @@index([userId, status, createdAt(sort: Desc)], name: "idx_order_user_status")
  // 3. Admin Dashboard (15% of queries)
  // Covers: WHERE status = 'PENDING' ORDER BY createdAt DESC
  @@index([status, createdAt(sort: Desc)], name: "idx_order_status_date")
  // 4. Payment Status Filter (5% of queries)
  // Covers: WHERE paymentStatus = 'UNPAID' AND createdAt < X (for auto-cancel)
  @@index([paymentStatus, createdAt], name: "idx_order_payment_created")
  // 5. Shipping Code Lookup
  @@index([shippingCode], name: "idx_order_shipping_code")
  @@index([tenantId])
  @@index([tenantId, status, createdAt]) // For Tenant Admin Dashboard
}

// =====================================================================
// 2. PARTIAL FULFILLMENT & LOGISTICS (GIAO V·∫¨N T√ÅCH ƒê∆†N)
// =====================================================================

model Shipment {
  id           String         @id @default(uuid())
  orderId      String
  status       ShipmentStatus @default(PENDING)
  carrier      String? // GHN, GHTK, DHL, Grab
  trackingCode String?
  shippedAt    DateTime?
  deliveredAt  DateTime?

  order    Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  tenantId String
  tenant   Tenant         @relation(fields: [tenantId], references: [id])
  items    ShipmentItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([tenantId])
}

// =====================================================================
// 3. TAX & COMPLIANCE (THU·∫æ & PH√ÅP L√ù)
// =====================================================================

model TaxRate {
  id       String  @id @default(uuid())
  name     String // VAT 10%, VAT 5%
  rate     Decimal @db.Decimal(5, 2)
  isActive Boolean @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model OrderTaxDetail {
  id      String  @id @default(uuid())
  orderId String
  name    String
  rate    Decimal @db.Decimal(5, 2)
  amount  Decimal @db.Decimal(20, 2)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([tenantId])
}

// =====================================================================
// 4. LOYALTY & CUSTOMER CARE (T√çCH ƒêI·ªÇM & CHƒÇM S√ìC)
// =====================================================================

model LoyaltyPoint {
  id        String           @id @default(uuid())
  userId    String
  orderId   String?
  amount    Int // D∆∞∆°ng: t√≠ch ƒëi·ªÉm, √Çm: ti√™u ƒëi·ªÉm
  type      LoyaltyPointType @default(EARNED)
  reason    String?
  expiresAt DateTime? // Ng√†y h·∫øt h·∫°n ƒëi·ªÉm (th∆∞·ªùng 1-2 nƒÉm)

  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([tenantId])
  @@index([expiresAt]) // Index ƒë·ªÉ l·ªçc ƒëi·ªÉm h·∫øt h·∫°n
}

enum LoyaltyPointType {
  EARNED
  REDEEMED
  REFUNDED
}

model ShipmentItem {
  id          String @id @default(uuid())
  shipmentId  String
  orderItemId String
  quantity    Int

  shipment  Shipment  @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  orderItem OrderItem @relation(fields: [orderItemId], references: [id])

  @@index([shipmentId])
  @@index([orderItemId])
}

enum ShipmentStatus {
  PENDING
  READY_TO_SHIP
  SHIPPED
  DELIVERED
  FAILED
  RETURNED
}

// =====================================================================
// 2. PARTIAL FULFILLMENT & LOGISTICS (GIAO V·∫¨N T√ÅCH ƒê∆†N)
// =====================================================================

// =====================================================================
// RMA - RETURN MERCHANDISE AUTHORIZATION
// =====================================================================

model ReturnRequest {
  id           String       @id @default(uuid())
  orderId      String
  userId       String
  status       ReturnStatus @default(PENDING) // Tr·∫°ng th√°i y√™u c·∫ßu
  reason       String // L√Ω do ƒë·ªïi tr·∫£
  description  String? // M√¥ t·∫£ chi ti·∫øt
  refundAmount Decimal?     @db.Decimal(20, 2) // S·ªë ti·ªÅn ho√†n l·∫°i d·ª± ki·∫øn
  images       String[] // Danh s√°ch ·∫£nh b·∫±ng ch·ª©ng

  // 1. Classification
  type ReturnType @default(RETURN_AND_REFUND)

  // 2. Logistics (How the item gets back)
  returnMethod  ReturnMethod @default(SELF_SHIP)
  trackingCode  String? // M√£ v·∫≠n ƒë∆°n user g·ª≠i tr·∫£
  carrier       String? // ƒê∆°n v·ªã v·∫≠n chuy·ªÉn (GHN, GHTK)
  pickupAddress Json? // ƒê·ªãa ch·ªâ l·∫•y h√†ng (n·∫øu Shop ƒë·∫øn l·∫•y)

  // 3. Finance
  refundMethod RefundMethod @default(ORIGINAL_PAYMENT)
  bankAccount  Json? // { bankName, number, owner } if refunding via Bank Transfer

  // 4. Processing
  inspectionNotes String? // Ghi ch√∫ ki·ªÉm h√†ng c·ªßa Admin
  rejectedReason  String? // L√Ω do t·ª´ ch·ªëi (n·∫øu c√≥)

  tenantId String
  tenant   Tenant       @relation(fields: [tenantId], references: [id])
  order    Order        @relation(fields: [orderId], references: [id])
  user     User         @relation(fields: [userId], references: [id])
  items    ReturnItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([userId])
  @@index([tenantId])
  @@index([status]) // Th√™m index tr·∫°ng th√°i ƒë·ªÉ l·ªçc nhanh
}

model ReturnItem {
  id              String @id @default(uuid())
  returnRequestId String
  orderItemId     String
  quantity        Int

  returnRequest ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)
  orderItem     OrderItem     @relation(fields: [orderItemId], references: [id])

  @@index([returnRequestId])
}

enum ReturnStatus {
  PENDING // Ch·ªù duy·ªát
  APPROVED // ƒê√£ duy·ªát (Ch·ªù kh√°ch g·ª≠i)
  WAITING_FOR_RETURN // ƒêang ƒë·ª£i h√†ng v·ªÅ
  IN_TRANSIT // ƒêang v·∫≠n chuy·ªÉn v·ªÅ
  RECEIVED // Shop ƒë√£ nh·∫≠n
  INSPECTING // ƒêang ki·ªÉm h√†ng
  REFUNDED // ƒê√£ ho√†n ti·ªÅn
  REJECTED // T·ª´ ch·ªëi
  CANCELLED // Kh√°ch h·ªßy
}

enum ReturnType {
  REFUND_ONLY // Ho√†n ti·ªÅn kh√¥ng c·∫ßn tr·∫£ h√†ng
  RETURN_AND_REFUND // Tr·∫£ h√†ng r·ªìi ho√†n ti·ªÅn
  EXCHANGE // ƒê·ªïi h√†ng (Future)
}

enum ReturnMethod {
  AT_COUNTER // Mang ra c·ª≠a h√†ng
  PICKUP // Shipper ƒë·∫øn l·∫•y
  SELF_SHIP // T·ª± g·ª≠i b∆∞u ƒëi·ªán
}

enum RefundMethod {
  ORIGINAL_PAYMENT // V·ªÅ th·∫ª/V√≠ ban ƒë·∫ßu
  BANK_TRANSFER // Chuy·ªÉn kho·∫£n (cho ƒë∆°n COD)
  WALLET // Ho√†n v·ªÅ v√≠ t√≠ch ƒëi·ªÉm
}

model OrderItem {
  id              String  @id @default(uuid()) // ID d√≤ng chi ti·∫øt ƒë∆°n h√†ng
  orderId         String // ID ƒê∆°n h√†ng
  skuId           String // ID SKU
  quantity        Int // S·ªë l∆∞·ª£ng mua
  priceAtPurchase Decimal @db.Decimal(20, 2) // Gi√° t·∫°i th·ªùi ƒëi·ªÉm mua (quan tr·ªçng ƒë·ªÉ kh√¥ng b·ªã ƒë·ªïi khi gi√° g·ªëc ƒë·ªïi)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sku   Sku   @relation(fields: [skuId], references: [id])

  // Denormalized Data for Historial Integrity & Performance
  productName     String? // T√™n s·∫£n ph·∫©m l√∫c mua (L∆∞u c·ª©ng)
  skuNameSnapshot String? // T√™n SKU l√∫c mua (L∆∞u c·ª©ng)
  productSlug     String? // Slug l√∫c mua
  imageUrl        String? // ·∫¢nh l√∫c mua

  shipmentItems ShipmentItem[]
  returnItems   ReturnItem[]

  @@unique([orderId, skuId]) // M·ªôt SKU ch·ªâ xu·∫•t hi·ªán 1 l·∫ßn trong ƒë∆°n
  @@index([skuId]) // Tham chi·∫øu
  @@index([tenantId])
}

model Review {
  id         String    @id @default(uuid()) // ID ƒë√°nh gi√°
  userId     String // ID ng∆∞·ªùi ƒë√°nh gi√°
  productId  String // ID s·∫£n ph·∫©m ƒë∆∞·ª£c ƒë√°nh gi√°
  rating     Int       @db.SmallInt // S·ªë sao (1-5)
  content    String? // N·ªôi dung ƒë√°nh gi√°
  isApproved Boolean   @default(false) // Tr·∫°ng th√°i duy·ªát (ch·ªëng spam)
  createdAt  DateTime  @default(now()) // Ng√†y ƒë√°nh gi√°
  updatedAt  DateTime  @updatedAt // Ng√†y c·∫≠p nh·∫≠t
  deletedAt  DateTime? // X√≥a m·ªÅm
  skuId      String? // Review cho bi·∫øn th·ªÉ n√†o
  images     String[] // ·∫¢nh ƒë√≠nh k√®m
  reply      String? // Ph·∫£n h·ªìi c·ªßa shop
  replyAt    DateTime? // Th·ªùi gian ph·∫£n h·ªìi
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku        Sku?      @relation(fields: [skuId], references: [id])
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenancy (ƒêa c·ª≠a h√†ng) - M·ªói review thu·ªôc v·ªÅ m·ªôt tenant c·ª• th·ªÉ
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  // AI Analysis
  sentiment Sentiment? // C·∫£m x√∫c t√≠ch c·ª±c/ti√™u c·ª±c (AI ph√¢n t√≠ch)
  autoTags  String[] // Tag t·ª± ƒë·ªông (VD: ["shipping_issue", "product_quality", "service"])

  @@unique([userId, productId, skuId]) // M·ªói user ch·ªâ ƒë√°nh gi√° 1 l·∫ßn/SKU
  @@index([productId, rating]) // L·ªçc review theo sao
  @@index([skuId])
  @@index([tenantId])
  @@index([tenantId, productId, isApproved, createdAt(sort: Desc)]) // L·∫•y review hi·ªÉn th·ªã cho kh√°ch
  @@index([sentiment])
}

enum Sentiment {
  POSITIVE // T√≠ch c·ª±c
  NEGATIVE // Ti√™u c·ª±c
  NEUTRAL // Trung t√≠nh
}

// B·∫£ng l∆∞u nh·∫≠t k√Ω ho·∫°t ƒë·ªông (Audit Log)
// Strategy: Partitioning by Month (Native Postgres)
// This table should be converted to a partitioned table in migration.
model AuditLog {
  id        String   @default(uuid()) // ID ƒë·ªãnh danh log
  userId    String? // ID ng∆∞·ªùi th·ª±c hi·ªán h√†nh ƒë·ªông (c√≥ th·ªÉ null n·∫øu l√† system/anonymous)
  action    String // T√™n h√†nh ƒë·ªông (VD: "CREATE_PRODUCT", "DELETE_ORDER", "LOGIN")
  resource  String // T√†i nguy√™n b·ªã t√°c ƒë·ªông (VD: "Product", "Order", "System")
  payload   Json? // Chi ti·∫øt d·ªØ li·ªáu thay ƒë·ªïi (L∆∞u snapshot d·ªØ li·ªáu c≈©/m·ªõi ƒë·ªÉ so s√°nh)
  ipAddress String? // ƒê·ªãa ch·ªâ IP c·ªßa ng∆∞·ªùi th·ª±c hi·ªán
  userAgent String? // Th√¥ng tin tr√¨nh duy·ªát/thi·∫øt b·ªã c·ªßa ng∆∞·ªùi th·ª±c hi·ªán
  createdAt DateTime @default(now()) // Th·ªùi ƒëi·ªÉm ghi log

  user User? @relation(fields: [userId], references: [id]) // Link t·ªõi b·∫£ng User ƒë·ªÉ bi·∫øt ai l√†m

  // Composite ID is REQUIRED for time-based partitioning in Prisma/Postgres
  @@id([id, createdAt])
  @@index([userId])
  @@index([resource])
  @@index([action])
  @@index([payload], type: Gin)
}

model ProductTranslation {
  id          String  @id @default(uuid()) // ID
  productId   String // ID s·∫£n ph·∫©m
  locale      String // Ng√¥n ng·ªØ (en, vi...)
  name        String  @db.VarChar(255) // T√™n d·ªãch
  description String? // M√¥ t·∫£ d·ªãch
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale]) // M·ªói s·∫£n ph·∫©m ch·ªâ c√≥ 1 b·∫£n d·ªãch cho 1 ng√¥n ng·ªØ
  @@index([productId])
  @@index([locale])
}

model ProductImage {
  id      String  @id @default(uuid()) // ID ·∫£nh
  url     String // URL ·∫£nh (Legacy or Direct Link)
  mediaId String?

  alt          String? // VƒÉn b·∫£n thay th·∫ø (SEO)
  displayOrder Int     @default(0) // Th·ª© t·ª± hi·ªÉn th·ªã
  productId    String // ID s·∫£n ph·∫©m

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  media   Media?  @relation(fields: [mediaId], references: [id])
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([tenantId])
}

model SkuImage {
  id      String  @id @default(uuid()) // ID ·∫£nh bi·∫øn th·ªÉ
  url     String // URL ·∫£nh
  mediaId String?

  alt          String? // SEO
  displayOrder Int     @default(0) // Th·ª© t·ª±
  skuId        String // ID SKU

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  media Media? @relation(fields: [mediaId], references: [id])
  sku   Sku    @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@index([skuId])
  @@index([tenantId])
}

model Notification {
  id        String   @id @default(uuid()) // ID th√¥ng b√°o
  type      String // Lo·∫°i (ORDER_UPDATE, PROMOTION...)
  title     String // Ti√™u ƒë·ªÅ
  message   String // N·ªôi dung
  isRead    Boolean  @default(false) // ƒê√£ ƒë·ªçc ch∆∞a
  link      String? // Link ƒëi·ªÅu h∆∞·ªõng khi click
  createdAt DateTime @default(now()) // Ng√†y t·∫°o
  userId    String // Ng∆∞·ªùi nh·∫≠n
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
}

model InventoryLog {
  id            String   @id @default(uuid()) // ID log kho
  skuId         String // ID SKU
  changeAmount  Int // S·ªë l∆∞·ª£ng thay ƒë·ªïi (+ nh·∫≠p, - xu·∫•t)
  previousStock Int // T·ªìn tr∆∞·ªõc khi ƒë·ªïi
  newStock      Int // T·ªìn sau khi ƒë·ªïi
  reason        String // L√Ω do (Nh·∫≠p h√†ng, B√°n h√†ng, Ho√†n tr·∫£...)
  userId        String? // Ng∆∞·ªùi th·ª±c hi·ªán
  createdAt     DateTime @default(now()) // Ng√†y ghi
  sku           Sku      @relation(fields: [skuId], references: [id], onDelete: Cascade)
  user          User?    @relation(fields: [userId], references: [id])

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@index([skuId])
  @@index([userId])
  @@index([tenantId])
}

model Wishlist {
  id        String   @id @default(uuid()) // ID b·∫£n ghi y√™u th√≠ch
  userId    String // ID User
  productId String // ID S·∫£n ph·∫©m
  createdAt DateTime @default(now()) // Ng√†y like
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([userId, productId]) // User ch·ªâ like 1 l·∫ßn/sp
  @@index([userId])
  @@index([tenantId])
  @@index([tenantId, userId, createdAt(sort: Desc)])
}

model Blog {
  id        String  @id @default(uuid()) // ID b√†i vi·∫øt
  title     String  @db.VarChar(255) // Ti√™u ƒë·ªÅ
  slug      String  @db.VarChar(255) // URL th√¢n thi·ªán
  excerpt   String // ƒêo·∫°n tr√≠ch d·∫´n ng·∫Øn
  content   String // N·ªôi dung b√†i vi·∫øt (HTML)
  image     String? @db.VarChar(500) // ·∫¢nh ƒë·∫°i di·ªán b√†i vi·∫øt (Legacy)
  imageId   String?
  blogMedia Media?  @relation(fields: [imageId], references: [id])

  category       String        @db.VarChar(100) // Danh m·ª•c b√†i vi·∫øt
  author         String        @db.VarChar(100) // T√°c gi·∫£
  language       String        @default("en") @db.VarChar(5) // Ng√¥n ng·ªØ
  readTime       String?       @db.VarChar(20) // Th·ªùi gian ƒë·ªçc ∆∞·ªõc t√≠nh
  publishedAt    DateTime? // Ng√†y xu·∫•t b·∫£n
  createdAt      DateTime      @default(now()) // Ng√†y t·∫°o
  updatedAt      DateTime      @updatedAt // C·∫≠p nh·∫≠t
  deletedAt      DateTime? // X√≥a m·ªÅm
  userId         String? // Ng∆∞·ªùi vi·∫øt
  user           User?         @relation(fields: [userId], references: [id])
  products       BlogProduct[] // C√°c s·∫£n ph·∫©m ƒë∆∞·ª£c nh·∫Øc ƒë·∫øn
  referredOrders Order[]       @relation("BlogReferrals") // C√°c ƒë∆°n h√†ng ƒë∆∞·ª£c gi·ªõi thi·ªáu t·ª´ b√†i vi·∫øt n√†y

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, slug])
  @@index([slug])
  @@index([tenantId])
  @@index([tenantId, category])
  @@index([tenantId, publishedAt(sort: Desc)])
  @@index([category])
  @@index([language])
  @@index([publishedAt])
  @@index([userId])
  @@index([deletedAt])
}

model BlogProduct {
  blogId    String
  productId String
  createdAt DateTime @default(now())
  blog      Blog     @relation(fields: [blogId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([blogId, productId])
  @@index([blogId])
  @@index([productId])
}

model FeatureFlag {
  id          String   @id @default(uuid()) // ID c·ªù t√≠nh nƒÉng
  key         String   @unique // Kh√≥a ƒë·ªãnh danh (VD: NEW_CHECKOUT_FLOW)
  description String? // M√¥ t·∫£
  isEnabled   Boolean  @default(false) // B·∫≠t/T·∫Øt
  rules       Json? // Quy t·∫Øc √°p d·ª•ng (VD: ch·ªâ b·∫≠t cho user beta)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@index([key])
  @@index([tenantId])
}

enum OrderStatus {
  PENDING // Ch·ªù x·ª≠ l√Ω
  PROCESSING // ƒêang x·ª≠ l√Ω
  SHIPPED // ƒêang giao h√†ng
  DELIVERED // ƒê√£ giao h√†ng
  CANCELLED // ƒê√£ h·ªßy
  RETURNED // ƒê√£ tr·∫£ h√†ng
  COMPLETED // Ho√†n th√†nh (Sau khi ƒë√£ giao v√† h·∫øt h·∫°n ƒë·ªïi tr·∫£)
}

enum PaymentStatus {
  UNPAID // Ch∆∞a thanh to√°n
  PENDING // ƒêang ch·ªù thanh to√°n
  PAID // ƒê√£ thanh to√°n
  FAILED // Thanh to√°n th·∫•t b·∫°i
  REFUNDED // ƒê√£ ho√†n ti·ªÅn
}

model Payment {
  id                    String        @id @default(uuid()) // ID b·∫£n ghi thanh to√°n
  orderId               String // ID ƒê∆°n h√†ng
  amount                Decimal       @db.Decimal(20, 2) // S·ªë ti·ªÅn thanh to√°n
  currency              String        @default("VND") // ƒê∆°n v·ªã ti·ªÅn t·ªá
  status                PaymentStatus @default(PENDING) // Tr·∫°ng th√°i
  paymentMethod         String // Ph∆∞∆°ng th·ª©c (MOMO, VNPAY, STRIPE, COD)
  providerTransactionId String? // ID t·ª´ ph√≠a c·ªïng thanh to√°n (VD: M√£ giao d·ªãch Momo)
  metadata              Json? // L∆∞u log response t·ª´ Gateway (ƒë·ªÉ debug)
  paidAt                DateTime? // Th·ªùi ƒëi·ªÉm thanh to√°n th√†nh c√¥ng
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([tenantId])
}

model NewsletterSubscriber {
  id        String   @id @default(uuid()) // ID ng∆∞·ªùi ƒëƒÉng k√Ω
  email     String // Email
  isActive  Boolean  @default(true) // C√≤n ƒëƒÉng k√Ω kh√¥ng
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  tenantId String // ID Tenant
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, email])
  @@index([email])
  @@index([tenantId])
}

model ChatConversation {
  id        String        @id @default(uuid()) // ID h·ªôi tho·∫°i
  userId    String // ID kh√°ch h√†ng
  isActive  Boolean       @default(true) // ƒêang ho·∫°t ƒë·ªông
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  user      User          @relation(fields: [userId], references: [id])
  messages  ChatMessage[] // C√°c tin nh·∫Øn

  @@unique([userId])
  @@index([userId])
  @@index([updatedAt])
}

model ChatMessage {
  id             String           @id @default(uuid()) // ID tin nh·∫Øn
  conversationId String // ID h·ªôi tho·∫°i
  senderId       String // ID ng∆∞·ªùi g·ª≠i
  senderType     SenderType       @default(USER) // Lo·∫°i ng∆∞·ªùi g·ª≠i (Admin/User)
  content        String // N·ªôi dung tin nh·∫Øn
  type           MessageType      @default(TEXT) // Lo·∫°i tin (Text, ·∫¢nh, S·∫£n ph·∫©m)
  metadata       Json? // D·ªØ li·ªáu ƒë√≠nh k√®m
  isRead         Boolean          @default(false) // ƒê√£ ƒë·ªçc ch∆∞a
  sentAt         DateTime         @default(now()) // Th·ªùi gian g·ª≠i
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([sentAt])
}

enum SenderType {
  USER // Kh√°ch h√†ng
  ADMIN // Qu·∫£n tr·ªã vi√™n
}

enum MessageType {
  TEXT // VƒÉn b·∫£n
  IMAGE // H√¨nh ·∫£nh
  PRODUCT // G·ª≠i s·∫£n ph·∫©m t∆∞ v·∫•n
  ORDER // G·ª≠i th√¥ng tin ƒë∆°n h√†ng
}

model PerformanceMetric {
  id             String   @default(uuid())
  name           String // T√™n ch·ªâ s·ªë (LCP, FID, CLS, FCP, TTFB, INP)
  value          Float // Gi√° tr·ªã ƒëo ƒë∆∞·ª£c
  rating         String // X·∫øp h·∫°ng (good, needs-improvement, poor)
  url            String // URL trang web ƒëo
  userAgent      String? // Tr√¨nh duy·ªát c·ªßa user
  navigationType String? // Ki·ªÉu ƒëi·ªÅu h∆∞·ªõng (navigate, reload...)
  createdAt      DateTime @default(now())

  @@id([id, createdAt])
  @@index([name])
  @@index([createdAt])
}

// =====================================================================
// AI CHAT - T√≠nh nƒÉng chat v·ªõi AI s·ª≠ d·ª•ng Google Gemini
// =====================================================================

model AiChatSession {
  id        String          @id @default(uuid()) // ID phi√™n chat
  userId    String? // ID User (n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p)
  guestId   String? // UUID l∆∞u local storage (n·∫øu l√† kh√°ch)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  messages  AiChatMessage[] // Danh s√°ch tin nh·∫Øn

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([guestId])
  @@index([createdAt])
}

model AiChatMessage {
  id        String     @id @default(uuid()) // ID tin nh·∫Øn
  sessionId String // ID phi√™n chat
  role      AiChatRole // Vai tr√≤ (Ng∆∞·ªùi d√πng / Tr·ª£ l√Ω ·∫£o)
  content   String     @db.Text // N·ªôi dung chat (c√≥ th·ªÉ d√†i)
  metadata  Json? // Metadata (s·∫£n ph·∫©m g·ª£i √Ω, tokens...)
  createdAt DateTime   @default(now())

  session AiChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
}

enum AiChatRole {
  USER // Ng∆∞·ªùi d√πng
  ASSISTANT // Tr·ª£ l√Ω ·∫£o
}

// =====================================================================
// RELIABILITY - Transactional Outbox Pattern
// =====================================================================

model OutboxEvent {
  id            String       @id @default(uuid())
  aggregateType String // Lo·∫°i ƒë·ªëi t∆∞·ª£ng (VD: "ORDER")
  aggregateId   String // ID ƒë·ªëi t∆∞·ª£ng (VD: Order ID)
  type          String // Lo·∫°i s·ª± ki·ªán (VD: "ORDER_CREATED")
  payload       Json // D·ªØ li·ªáu s·ª± ki·ªán
  createdAt     DateTime     @default(now())
  processedAt   DateTime? // Th·ªùi gian x·ª≠ l√Ω xong
  status        OutboxStatus @default(PENDING) // Tr·∫°ng th√°i
  error         String? // L·ªói n·∫øu c√≥

  @@index([status, createdAt])
}

enum OutboxStatus {
  PENDING // Ch∆∞a x·ª≠ l√Ω
  PROCESSING // ƒêang x·ª≠ l√Ω
  COMPLETED // ƒê√£ xong
  FAILED // Th·∫•t b·∫°i
}

// =====================================================================
// MULTI-TENANCY
// =====================================================================

model Tenant {
  id      String  @id @default(uuid()) // ID ƒë·ªãnh danh Tenant (C·ª≠a h√†ng)
  name    String // T√™n c·ª≠a h√†ng
  ownerId String?
  owner   User?   @relation("TenantOwner", fields: [ownerId], references: [id])

  // Domain Management
  subdomain    String? @unique // Subdomain h·ªá th·ªëng (shop-a.platform.com)
  customDomain String? @unique // T√™n mi·ªÅn ri√™ng (mycustomstore.com)
  domain       String  @unique // Domain ch√≠nh (ƒë·ªÉ ƒë·ªãnh tuy·∫øn)

  // Settings & Localization
  currency String @default("VND") // ƒê∆°n v·ªã ti·ªÅn t·ªá ch√≠nh
  timezone String @default("Asia/Ho_Chi_Minh") // M√∫i gi·ªù m·∫∑c ƒë·ªãnh
  locale   String @default("vi-VN") // Ng√¥n ng·ªØ/V√πng m·∫∑c ƒë·ªãnh

  // Branding & Assets
  themeConfig Json? // C·∫•u h√¨nh giao di·ªán (M√†u s·∫Øc, Font...)
  logoUrl     String? // Logo
  faviconUrl  String? // Favicon

  // Business Information
  contactEmail String? // Email li√™n h·ªá
  contactPhone String? // SƒêT li√™n h·ªá
  address      String? // ƒê·ªãa ch·ªâ kinh doanh

  // Lifecycle & Status
  plan             TenantPlan @default(BASIC) // G√≥i d·ªãch v·ª•
  isActive         Boolean    @default(true) // Tr·∫°ng th√°i ho·∫°t ƒë·ªông
  suspendedAt      DateTime? // Th·ªùi ƒëi·ªÉm b·ªã treo
  suspensionReason String? // L√Ω do treo (n·ª£ c∆∞·ªõc, vi ph·∫°m...)
  deletedAt        DateTime? // Th·ªùi ƒëi·ªÉm x√≥a m·ªÅm (Soft delete). Ch·ªâ SuperAdmin m·ªõi c√≥ quy·ªÅn x√≥a c·ª©ng.

  // Infrastructure
  dbUrl String? // URL Database ri√™ng (Ch·∫ø ƒë·ªô Silo)

  // ===================== SAAS ONBOARDING =====================
  // Onboarding Status
  onboardingCompleted Boolean @default(false) // ƒê√£ ho√†n th√†nh setup?
  onboardingStep      Int     @default(0) // B∆∞·ªõc hi·ªán t·∫°i trong wizard (0-4)

  // Trial Period
  trialEndsAt DateTime? // Ng√†y k·∫øt th√∫c trial (14 ng√†y sau ƒëƒÉng k√Ω)
  trialStartedAt DateTime? // Ng√†y b·∫Øt ƒë·∫ßu trial

  // ===================== PLAN LIMITS =====================
  // Limits from SubscriptionPlan (cached for quick access)
  productLimit Int @default(100) // Gi·ªõi h·∫°n s·ªë s·∫£n ph·∫©m
  storageLimit Int @default(1024) // Gi·ªõi h·∫°n dung l∆∞·ª£ng (MB)
  staffLimit   Int @default(2) // Gi·ªõi h·∫°n s·ªë nh√¢n vi√™n

  // ===================== USAGE STATS =====================
  currentProductCount Int @default(0) // S·ªë s·∫£n ph·∫©m hi·ªán t·∫°i
  currentStorageUsed  Int @default(0) // Dung l∆∞·ª£ng ƒë√£ d√πng (MB)
  currentStaffCount   Int @default(0) // S·ªë nh√¢n vi√™n hi·ªán t·∫°i

  // ===================== ADDITIONAL INFO =====================
  businessType     String? // Lo·∫°i h√¨nh kinh doanh: fashion, electronics, food...
  businessSize     String? // Quy m√¥: small, medium, large
  monthlyRevenue   String? // Doanh thu h√†ng th√°ng (d·ª± ki·∫øn)
  referralCode     String? @unique // M√£ gi·ªõi thi·ªáu c·ªßa tenant n√†y
  referredByCode   String? // M√£ gi·ªõi thi·ªáu c·ªßa ng∆∞·ªùi ƒë√£ m·ªùi

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users                 User[]
  products              Product[]
  orders                Order[]
  blogs                 Blog[]
  reviews               Review[]
  carts                 Cart[]
  wishlists             Wishlist[]
  addresses             Address[]
  inventoryLogs         InventoryLog[]
  featureFlags          FeatureFlag[]
  pages                 Page[]
  translations          Translation[]
  categories            Category[]
  brands                Brand[]
  payments              Payment[]
  skus                  Sku[]
  roles                 Role[]
  newsletterSubscribers NewsletterSubscriber[]

  // Core features
  warehouses     Warehouse[]
  promotions     Promotion[]
  customerGroups CustomerGroup[]
  returnRequests ReturnRequest[]
  priceLists     PriceList[]
  media          Media[]

  // Step 1: Procurement
  suppliers      Supplier[]
  purchaseOrders PurchaseOrder[]

  // Step 2: Fulfillment
  shipments Shipment[]

  // Step 3: Tax
  taxRates TaxRate[]

  // Step 4: Loyalty
  loyaltyPoints LoyaltyPoint[]

  // Analytics
  metrics StoreMetrics[]

  // Billing
  subscription        Subscription?
  invoices            Invoice[]
  priceListItems      PriceListItem[]
  productToCategories ProductToCategory[]
  productOptions      ProductOption[]
  optionValues        OptionValue[]
  inventoryItems      InventoryItem[]
  skuToOptionValues   SkuToOptionValue[]
  cartItems           CartItem[]
  promotionRules      PromotionRule[]
  promotionActions    PromotionAction[]
  promotionUsages     PromotionUsage[]
  orderTaxDetails     OrderTaxDetail[]
  orderItems          OrderItem[]
  productImages       ProductImage[]
  skuImages           SkuImage[]

  @@index([deletedAt]) // Index gi√∫p l·ªçc nhanh c√°c tenant ch∆∞a b·ªã x√≥a
}

model Supplier {
  id        String    @id @default(uuid())
  name      String
  email     String?
  phone     String?
  address   String?
  notes     String?
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  purchaseOrders PurchaseOrder[]

  @@index([tenantId])
}

model PurchaseOrder {
  id          String              @id @default(uuid())
  supplierId  String
  tenantId    String
  status      PurchaseOrderStatus @default(PENDING)
  notes       String?
  totalAmount Decimal             @default(0) @db.Decimal(20, 2)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  supplier Supplier            @relation(fields: [supplierId], references: [id])
  tenant   Tenant              @relation(fields: [tenantId], references: [id])
  items    PurchaseOrderItem[]

  @@index([supplierId])
  @@index([tenantId])
}

model PurchaseOrderItem {
  id              String  @id @default(uuid())
  purchaseOrderId String
  skuId           String
  quantity        Int
  costPrice       Decimal @db.Decimal(20, 2)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  sku           Sku           @relation(fields: [skuId], references: [id])

  @@index([purchaseOrderId])
  @@index([skuId])
}

enum PurchaseOrderStatus {
  PENDING
  SHIPPED
  DELIVERED
  CANCELLED
}

model StoreMetrics {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  date           DateTime @default(now()) // Ng√†y th·ªëng k√™
  totalOrders    Int      @default(0) // T·ªïng s·ªë ƒë∆°n h√†ng
  totalRevenue   Decimal  @default(0) @db.Decimal(20, 2) // T·ªïng doanh thu (sau chi·∫øt kh·∫•u)
  totalVisits    Int      @default(0) // T·ªïng l∆∞·ª£t truy c·∫≠p
  conversionRate Float    @default(0) // T·ª∑ l·ªá chuy·ªÉn ƒë·ªïi (%)

  @@unique([tenantId, date])
  @@index([tenantId])
}

model Translation {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  locale   String // Ng√¥n ng·ªØ (en, vi)
  key      String // Kh√≥a d·ªãch (VD: home.welcome)
  value    String // Gi√° tr·ªã d·ªãch (VD: "Ch√†o m·ª´ng b·∫°n")

  updatedAt DateTime @updatedAt

  @@unique([tenantId, locale, key])
  @@index([tenantId, locale])
}

enum TenantPlan {
  BASIC // C∆° b·∫£n
  PRO // Chuy√™n nghi·ªáp
  ENTERPRISE // Doanh nghi·ªáp l·ªõn
}

model Page {
  id          String  @id @default(uuid()) // ID trang
  tenantId    String // ID Tenant
  tenant      Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  slug        String // URL (/, /about-us)
  title       String // Ti√™u ƒë·ªÅ trang
  isPublished Boolean @default(true) // Tr·∫°ng th√°i xu·∫•t b·∫£n

  // The magic: JSON-based Block Structure
  // [ { "type": "Hero", "props": { ... } }, { "type": "ProductGrid", "props": { ... } } ]
  blocks Json @default("[]") // C·∫•u tr√∫c n·ªôi dung d·∫°ng kh·ªëi (CMS)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([tenantId, slug]) // Slug duy nh·∫•t trong Tenant
  @@index([tenantId])
}

// =====================================================================
// BILLING & SUBSCRIPTIONS
// =====================================================================

model Subscription {
  id       String     @id @default(uuid())
  tenantId String     @unique // 1 Tenant ch·ªâ c√≥ 1 Subscription active
  plan     TenantPlan // G√≥i hi·ªán t·∫°i

  planId           String?
  subscriptionPlan SubscriptionPlan? @relation(fields: [planId], references: [id])

  billingFrequency  BillingFrequency @default(MONTHLY) // Chu k·ª≥ thanh to√°n (Th√°ng/NƒÉm)
  startDate         DateTime         @default(now()) // Ng√†y b·∫Øt ƒë·∫ßu g√≥i
  nextBillingDate   DateTime // Ng√†y thanh to√°n ti·∫øp theo
  isActive          Boolean          @default(true) // Tr·∫°ng th√°i g√≥i (ƒêang ho·∫°t ƒë·ªông?)
  cancelAtPeriodEnd Boolean          @default(false) // H·ªßy gia h·∫°n khi h·∫øt k·ª≥

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  invoices Invoice[] // L·ªãch s·ª≠ h√≥a ƒë∆°n

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id             String        @id @default(uuid()) // ID h√≥a ƒë∆°n
  tenantId       String
  subscriptionId String?
  amount         Decimal       @db.Decimal(10, 2) // S·ªë ti·ªÅn thanh to√°n
  currency       String        @default("VND") // ƒê∆°n v·ªã ti·ªÅn t·ªá
  status         InvoiceStatus @default(PENDING) // Tr·∫°ng th√°i h√≥a ƒë∆°n
  description    String? // M√¥ t·∫£ chi ti·∫øt
  paidAt         DateTime? // Th·ªùi ƒëi·ªÉm thanh to√°n th√†nh c√¥ng
  dueDate        DateTime // H·∫°n ch√≥t thanh to√°n

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([status])
}

enum BillingFrequency {
  MONTHLY // H√†ng th√°ng
  YEARLY // H√†ng nƒÉm
}

enum InvoiceStatus {
  PENDING // ƒêang ch·ªù thanh to√°n
  PAID // ƒê√£ thanh to√°n th√†nh c√¥ng
  OVERDUE // Qu√° h·∫°n thanh to√°n
  CANCELLED // ƒê√£ h·ªßy b·ªè
  VOID // V√¥ hi·ªáu h√≥a
}

model SubscriptionPlan {
  id          String  @id @default(uuid()) // ID g√≥i
  name        String // T√™n g√≥i (Basic, Pro, Enterprise)
  slug        String  @unique // Slug ƒë·ªãnh danh
  description String? // M√¥ t·∫£ ng·∫Øn

  // Pricing
  priceMonthly Decimal @default(0) @db.Decimal(10, 2) // Gi√° th√°ng
  priceYearly  Decimal @default(0) @db.Decimal(10, 2) // Gi√° nƒÉm
  currency     String  @default("VND") // ƒê∆°n v·ªã ti·ªÅn

  // Limits
  maxProducts    Int     @default(100) // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
  maxStorage     Int     @default(1024) // Gi·ªõi h·∫°n dung l∆∞·ª£ng l∆∞u tr·ªØ (MB)
  maxStaff       Int     @default(2) // Gi·ªõi h·∫°n s·ªë nh√¢n vi√™n
  maxWarehouses  Int     @default(1) // Gi·ªõi h·∫°n s·ªë kho
  transactionFee Decimal @default(0.0) @db.Decimal(5, 2) // Ph√≠ giao d·ªãch s√†n (%)

  // Features (JSON array of feature strings)
  features Json? @default("[]") // ["Custom Domain", "AI Chatbot", "B2B Price Lists"]

  // Display Settings
  sortOrder    Int     @default(0) // Th·ª© t·ª± hi·ªÉn th·ªã tr√™n pricing page
  badge        String? // Badge text: "Ph·ªï bi·∫øn nh·∫•t", "Ti·∫øt ki·ªám 20%"
  isPopular    Boolean @default(false) // Highlight g√≥i n√†y
  isActive     Boolean @default(true) // Tr·∫°ng th√°i ƒëang b√°n
  isPublic     Boolean @default(true) // Hi·ªÉn th·ªã c√¥ng khai tr√™n b·∫£ng gi√°
  trialDays    Int     @default(14) // S·ªë ng√†y trial cho g√≥i n√†y

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]
}

// =====================================================================
// PLATFORM SETTINGS (C·∫•u h√¨nh to√†n b·ªô platform - Super Admin only)
// =====================================================================

model PlatformSetting {
  id    String @id @default(uuid())
  key   String @unique // VD: "platform.name", "platform.commission_rate"
  value Json // Gi√° tr·ªã d·∫°ng JSON ƒë·ªÉ linh ho·∫°t

  description String? // M√¥ t·∫£ setting
  type        String  @default("string") // string, number, boolean, json
  isPublic    Boolean @default(false) // C√≥ public qua API kh√¥ng

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =====================================================================
// COMMISSION & AFFILIATE (HOA H·ªíNG & TI·∫æP TH·ªä LI√äN K·∫æT)
// =====================================================================

model CommissionTransaction {
  id        String           @id @default(uuid()) // ID giao d·ªãch hoa h·ªìng
  userId    String // ID ng∆∞·ªùi nh·∫≠n hoa h·ªìng (C·ªông t√°c vi√™n/Content Creator)
  orderId   String? // ID ƒë∆°n h√†ng li√™n quan n·∫øu hoa h·ªìng t·ª´ vi·ªác b√°n h√†ng
  amount    Decimal          @db.Decimal(20, 2) // S·ªë ti·ªÅn hoa h·ªìng
  type      CommissionType // Lo·∫°i hoa h·ªìng (Tr·ª±c ti·∫øp, C·∫•p 2, R√∫t ti·ªÅn...)
  status    CommissionStatus @default(COMPLETED) // Tr·∫°ng th√°i giao d·ªãch
  note      String? // Ghi ch√∫ th√™m
  createdAt DateTime         @default(now()) // Ng√†y t·∫°o giao d·ªãch

  user  User   @relation(fields: [userId], references: [id])
  order Order? @relation(fields: [orderId], references: [id])
}

enum CommissionType {
  DIRECT_REFERRAL // Hoa h·ªìng tr·ª±c ti·∫øp t·ª´ blog/link gi·ªõi thi·ªáu
  SUBSCRIPTION_FEE // Ph√≠ s√†n thu t·ª´ g√≥i thu√™ c·ªßa tenant
  TIER_2_REFERRAL // Hoa h·ªìng t·ª´ c·∫•p d∆∞·ªõi (Affiliate nhi·ªÅu c·∫•p)
  WITHDRAWAL // Giao d·ªãch r√∫t ti·ªÅn t·ª´ s·ªë d∆∞ hoa h·ªìng
}

enum CommissionStatus {
  PENDING // ƒêang ch·ªù x·ª≠ l√Ω
  COMPLETED // ƒê√£ ho√†n th√†nh
  CANCELLED // ƒê√£ h·ªßy
}
